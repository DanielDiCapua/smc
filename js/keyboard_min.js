var expr_xml_old,matrix_list=new Array,matrix_cont=0,xml_string='<math id="root"></math>',parser=new DOMParser,expr_xml=parser.parseFromString(xml_string,"text/xml"),xml_Serial=new XMLSerializer,text_screen="",StoredNode=null,currId="root",CursorPos=0,NumDigitLeft=0,NumDigitRight=0,isDecimalPoint=0,mn_cont=0,mo_cont=0,mi_cont=0,mfrac_cont=0,msqrt_cont=0,msup_cont=0,mfenced_cont=0,mtable_cont=0,mtr_cont=0,mtd_cont=0,mroot_cont=0,Matrix_cont=0,function_cont=0,parenthesis_cont=0,linsolve_cont=0,eigv_cont=0,normalize_cont=0,UDF_cont=0,Shift_state=0,State_ini=0,State_changed=1,num_format_type="automatic",num_decimals=4,exp_min=-1,exp_max=5,numericalZero=1e-12,angles_units="radians",body_list=["#bodyCalculator","#bodyMatrix","#bodyConfig","#bodyAbout","#bodyInputFunName","#bodyInputVarName"],MenuList=["#ConfigListMenu","#LibFunListMenu","#MenuShowParams","#UserDefFunMenu","#UserCreateVarsMenu"],SubMenuList=[[],[],[],["#subMenuInsertUserDefFun","#subMenuEditUserDefFun","#subMenuDeleteUserDefFun"],["#subMenuInsertVar","#subMenuEditVar","#subMenuDeleteVar"]],buttonMenu_list=["#btnConfig","#btnLibFun","#btnShowParamsMenu","#btnUserDefFun","#btnVars"],buttonSubMenu_list=[[],[],[],["#btnInsertUserDefFun","#btnEditUserDefFun","#btnDeleteUserDefFun"],["#btnInsertVar","#btnEditVar","#btnDeleteVar"]],typeMenu_list=["drop-down","drop-up","drop-up-right","drop-up-right","drop-up"],typeSubMeny_list=[[],[],[],["move-right","move-right","move-right"],["move-left","move-left","move-left"]],varNode_list=[],varLabel_list=[],varType_list=[],isInputVarActivated=!1,isEditModeInputVar=!1,currIvar=-1,userDefFunNode_list=[],userDefFunLabel_list=[],userDefFunParamType_list=[],userDefFunParamNames=[],userDefFunExpr_list=[],isParamListCreated=!1,isInputUSFActivated=!1,isEditModeInputUserDefFun=!1,curr_UDF=-1,OrderIndexVarAndFun=[],prodSymbol_list=["∧","⊗",":"],prodFunction_list=["cross","TensorProduct","DoubleContraction"],storage=null;function ActiveBody(e){for(ibody=0;ibody<body_list.length;ibody++)body_list[ibody]==e?$(body_list[ibody]).show():$(body_list[ibody]).hide()}function load(){$(document).ready(function(){if(void 0!==window.localStorage?(ns=Storages.initNamespaceStorage("ScientificMatrixCal"),storage=ns.localStorage):storage=null,storage){if(storage.isSet("original_size")&&(original_size=storage.get("original_size"),expr_xml.documentElement.setAttribute("size",original_size),MathJax.Hub.Config({SVG:{scale:original_size}}),num_format_type=storage.get("num_format_type"),num_decimals=parseInt(storage.get("num_decimals")),exp_min=parseInt(storage.get("exp_min")),exp_max=parseInt(storage.get("exp_max")),angles_units=storage.get("angles_units")),storage.isSet("varNode_list")){var e=storage.get("varNode_list");e=JSON.parse(e);for(var r=new DOMParser,t=0;t<e.length;t++){var n=r.parseFromString(e[t],"text/xml");varNode_list[t]=n.firstChild}var i=storage.get("varLabel_list");varLabel_list=JSON.parse(i);var o=storage.get("varType_list");varType_list=JSON.parse(o);var a=storage.get("OrderIndexVarAndFun");OrderIndexVarAndFun=JSON.parse(a)}if(storage.isSet("userDefFunLabel_list")){userDefFunNode_list=[],userDefFunLabel_list=[],userDefFunParamType_list=[],userDefFunParamNames=[];var s=storage.get("userDefFunNode_list");s=JSON.parse(s);r=new DOMParser;for(var l=0;l<s.length;l++){n=r.parseFromString(s[l],"text/xml");userDefFunNode_list[l]=n.firstChild}var d=storage.get("userDefFunLabel_list");userDefFunLabel_list=JSON.parse(d);var u=storage.get("userDefFunParamType_list");userDefFunParamType_list=JSON.parse(u);var m=storage.get("userDefFunParamNames");userDefFunParamNames=JSON.parse(m);a=storage.get("OrderIndexVarAndFun");OrderIndexVarAndFun=JSON.parse(a)}}ActiveBody("#bodyCalculator"),window.document.getElementById("btnShift").onclick=function(){Shift_state=Shift_state==State_ini?State_changed:State_ini;var e=window.document.getElementById("btnPow"),r=window.document.getElementById("btnRoot"),t=window.document.getElementById("btnSin"),n=window.document.getElementById("btnCos"),i=window.document.getElementById("btnTan"),o=window.document.getElementById("btnFun");0==Shift_state?($(e).html("<strong>x</strong><sup>2</sup>"),$(r).html("<strong>&Sqrt;<span style='text-decoration:overline;  font-size:1.05em;'>&nbsp;x&nbsp;</span></strong>"),$(t).html("<strong>sin</strong>"),$(t).css("font-size","0.85em"),$(n).html("<strong>cos</strong>"),$(n).css("font-size","0.85em"),$(i).html("<strong>tan</strong>"),$(i).css("font-size","0.85em"),$(o).html("<strong>π</strong>"),$(o).css("font-size","0.85em")):1==Shift_state&&($(e).html("<strong>x</strong><sup>y</sup>"),$(r).html("<sup>y</sup><strong>&Sqrt;<span style='text-decoration:overline;  font-size:1.05em;'>&nbsp;x&nbsp;</span></strong>"),$(t).html("<strong>asin</strong>"),$(t).css("font-size","0.80em"),$(n).html("<strong>acos</strong>"),$(n).css("font-size","0.80em"),$(i).html("<strong>atan</strong>"),$(i).css("font-size","0.80em"),$(o).html("<strong><i style='font-family:Times New Roman;'>i</i></strong>"),$(o).css("font-size","0.80em"))};var c=document.getElementById("screenLine");c.addEventListener("touchstart",TouchStartHandler,!1),c.addEventListener("touchmove",TouchMoveHandler,!1),c.addEventListener("touchend",TouchEndHandler,!1),Preview.Init(),text_screen=xml_Serial.serializeToString(expr_xml),Preview.callback=MathJax.Callback(["CreatePreview",Preview]),Preview.callback.autoReset=!0,Preview.Update(),"radians"==angles_units?$("#angleLine_div strong").html("Angles(rad)"):"degrees"==angles_units&&$("#angleLine_div strong").html("Angles(deg)"),math.import({Gen_UDF:Gen_UDF,TensorProduct:TensorProduct,DoubleContraction:DoubleContraction})})}function PreferencesMenu(){ActiveBody("#bodyConfig");for(var e=original_size/1.5+"%",r=document.getElementById("defSize"),t=0;s=r.options[t];t++)if(s.value==e){r.selectedIndex=t;break}var n=document.getElementById("NumberFormat");for(t=0;s=n.options[t];t++)if(s.value==num_format_type){n.selectedIndex=t;break}var i=document.getElementById("NumDecimals");for(t=0;s=i.options[t];t++)if(s.value==num_decimals){i.selectedIndex=t;break}if("automatic"==num_format_type){var o=document.getElementById("lowerExp");for(t=0;s=o.options[t];t++)if(s.value==exp_min){o.selectedIndex=t;break}var a=document.getElementById("upperExp");for(t=0;s=a.options[t];t++)if(s.value==exp_max){a.selectedIndex=t;break}}var s,l=document.getElementById("anglesUnits");for(t=0;s=l.options[t];t++)if(s.value==angles_units){l.selectedIndex=t;break}}function ClosePreferences(){ActiveBody("#bodyCalculator"),DefineRowsHeight(),ZoomOriginal(),storage&&(storage.set("original_size",original_size),storage.set("num_format_type",num_format_type),storage.set("num_decimals",num_decimals),storage.set("exp_min",exp_min),storage.set("exp_max",exp_max),storage.set("angles_units",angles_units)),"radians"==angles_units?$("#angleLine_div strong").html("Angles(rad)"):"degrees"==angles_units&&$("#angleLine_div strong").html("Angles(deg)")}function CancelPreferences(){ActiveBody("#bodyCalculator"),DefineRowsHeight(),ZoomOriginal()}function ResetDataConfirmation(){1==confirm("This command will delete all the stored data (configuration preferences, variables and functions). Do you want to continue?")&&ResetData()}function ResetData(){0!=interval_var&&CloseInterval();document.getElementById("btnResetData");storage.removeAll(),ClearAll(),original_size=150,num_format_type="automatic",num_decimals=4,exp_min=-1,exp_max=5,numericalZero=1e-12,"radians"==(angles_units="radians")?$("#angleLine_div strong").html("Angles(rad)"):"degrees"==angles_units&&$("#angleLine_div strong").html("Angles(deg)"),numericalZero=1e-12,varNode_list=[],varLabel_list=[],varType_list=[],isInputVarActivated=!1,isEditModeInputVar=!1,currIvar=-1,userDefFunNode_list=[],userDefFunLabel_list=[],userDefFunParamType_list=[],userDefFunParamNames=[],userDefFunExpr_list=[],isParamListCreated=!1,isInputUSFActivated=!1,isEditModeInputUserDefFun=!1,curr_UDF=-1,OrderIndexVarAndFun=[],ZoomOriginal()}function HideAndShowKeyboard(){0!=interval_var&&CloseInterval();var e=document.getElementById("btnHideAndShowKeyboard");isKeyboardShowed?($("#keyboard_div").hide(),$(e).html("Show keyboard"),isKeyboardShowed=!1):($("#keyboard_div").show(),$(e).html("Hide keyboard"),isKeyboardShowed=!0),DefineRowsHeight(),isScreenMode&&(isInputVarActivated||Preview.UpdateCursorPosition())}function DefaultTextSize(e){var r=parseFloat(e.slice(0,e.length-1));original_size=1.5*parseFloat(r)}function DefineNumberFormat(e){"automatic"==(num_format_type=e)?($("#LowerExpP").show(),$("#UpperExpP").show()):($("#LowerExpP").hide(),$("#UpperExpP").hide())}function DefineNumDecimals(e){num_decimals=parseInt(e)}function DefineLowerExp(e){exp_min=parseInt(e)}function DefineUpperExp(e){exp_max=parseInt(e)}function DefaultAnglesUnit(e){angles_units=e}function LibraryFunctionsList(){var e=document.getElementById("LibFunListMenu");$(e).show(),PositionateMenu("#btnLibFun","#LibFunListMenu","drop-up-right")}function UserCreateVars(){var e=document.getElementById("UserCreateVarsMenu");$(e).show(),PositionateMenu("#btnVars","#UserCreateVarsMenu","drop-up")}function CloseSubMenus(){for(var e=0;e<SubMenuList.length;e++)for(var r=0;r<SubMenuList[e].length;r++)"block"==$(SubMenuList[e][r]).css("display")&&$(SubMenuList[e][r]).css("display","none")}function CreateVar(){if(0==eigv_cont){if(!IsUDF_DefinitionActive()&&!IsVar_DefinitionActive()){CloseSubMenus(),ActiveBody("#bodyInputVarName");var e=document.getElementById("var_name_text");e.value="",e.focus(),document.getElementById("var_type").selectedIndex=0,expr_xml_old=expr_xml.cloneNode(!0),isScreenMode_old=isScreenMode,ClearAll()}}else alert("Var storage is not allowed for eigenvalue analysis!!!")}function InputVarFocus(){isInputVarActivated=!0,0!=interval_var&&CloseInterval()}function InputVarBlur(e){isInputVarActivated=!1,isKeyboardShowed?Preview.UpdateCursorPosition():HideAndShowKeyboard()}function CreateUserDefFun(){if(0==eigv_cont){if(!IsUDF_DefinitionActive()&&!IsVar_DefinitionActive()){CloseSubMenus(),ActiveBody("#bodyInputFunName");var e=document.getElementById("fun_name_text");e.value="",e.focus(),document.getElementById("NumOfParams").selectedIndex=0,$(".name_parameter").remove(),$(".type_parameter").remove(),$(".name_parameter_label").remove(),$(".hr_line").remove(),isInputUSFActivated=!0,expr_xml_old=expr_xml.cloneNode(!0),isScreenMode_old=isScreenMode,ClearAll()}}else alert("Function storage is not allowed for eigenvalue analysis!!!")}function GetElementById(e,r){var t="[id='"+r+"']";return e.querySelector(t)}function CopyCurrNode(){var e;if(isScreenMode){if("root"==currId)return void alert("There is no node to copy!!!");if(!(e=GetElementById(expr_xml,currId)))return;if(IsGreyColorNode(e))return}else{if(0!=eigv_cont)return;e=GetElementById(expr_xml,"root").lastChild}if(isEditModeInputVar){var r=e.cloneNode(!0);varNode_list[currIvar]=r;var t=FindOutTypeOfNode(r);varType_list[currIvar]=t;var n=document.getElementById("var_text").value;varLabel_list[currIvar]=n}else{r=e.cloneNode(!0);varNode_list.push(r);t=FindOutTypeOfNode(r);varType_list.push(t);n=document.getElementById("var_text").value;varLabel_list.push(n)}if($("#inputVar_div").css("display","none"),!isKeyboardShowed){$("#keyboard_div").show();var i=document.getElementById("btnHideAndShowKeyboard");$(i).html("Hide keyboard"),isKeyboardShowed=!0}DefineRowsHeight(),Preview.UpdateCursorPosition(),document.getElementById("var_text").value=""}function CopyWholeExpresion(){var e=GetElementById(expr_xml,"root");if(isScreenMode){if("root"==currId)return void alert("There is no expression to copy!!!");r=e.cloneNode(!0)}else{if(0!=eigv_cont)return;lastChild=e.lastChild.cloneNode(!0);var r,t=(r=e.cloneNode(!0)).childNodes;do{var n=t[t.length-1];n&&r.removeChild(n)}while(0!=t.length);r.appendChild(lastChild)}if(IsGreekLetter(document.getElementById("var_name_text").value)&&(r=CorrectGreekLetterVar(r)),varNode_list[currIvar]=r,$("#inputVar_div").css("display","none"),!isKeyboardShowed){$("#keyboard_div").show();var i=document.getElementById("btnHideAndShowKeyboard");$(i).html("Hide keyboard"),isKeyboardShowed=!0}$("#screenLine").css("padding","15px 5px"),DefineRowsHeight(),Preview.UpdateCursorPosition(),document.getElementById("var_name_text").value=""}function CopyFunctionExpression(){var e=GetElementById(expr_xml,"root");if(isScreenMode){if("root"==currId)return void alert("There is no expression to copy!!!");r=e.cloneNode(!0)}else{if(0!=eigv_cont)return;lastChild=e.lastChild.cloneNode(!0);var r,t=(r=e.cloneNode(!0)).childNodes;do{var n=t[t.length-1];n&&r.removeChild(n)}while(0!=t.length);r.appendChild(lastChild)}if(r=CorrectGreekLetterParam(r),userDefFunNode_list[curr_UDF]=r,$("#inputFun_div").css("display","none"),!isKeyboardShowed){$("#keyboard_div").show();var i=document.getElementById("btnHideAndShowKeyboard");$(i).html("Hide keyboard"),isKeyboardShowed=!0}$("#screenLine").css("padding","15px 5px"),DefineRowsHeight(),Preview.UpdateCursorPosition()}function CorrectGreekLetterParam(e){for(var r=e.querySelectorAll("mi[type='param']"),t=0;t<r.length;t++){var n=r[t].childNodes[0].nodeValue;"&"==n.substring(0,1)&&(n=n.substring(1,n.length-1),r[t].childNodes[0].nodeValue=n)}return e}function CorrectGreekLetterVar(e){for(var r=e.querySelectorAll("mi[type='var']"),t=0;t<r.length;t++){var n=r[t].childNodes[0].nodeValue;"&"==n.substring(0,1)&&(n=n.substring(1,n.length-1),r[t].childNodes[0].nodeValue=n)}return e}function IsValidInputVarExpression(e){var r=!0;NodeColor_list=e.querySelectorAll("[color]");for(var t=0;t<NodeColor_list.length;t++){var n=NodeColor_list[t];if(!IsParamMiNode(n)&&!IsParamMnNode(n)){r=!1;break}}return r}function SaveInputVar(e){var r=expr_xml.documentElement,t=r.childNodes;if(isScreenMode){if(t.length<=1)return void alert("There is no node to copy!!!");if(!IsValidInputVarExpression(expr_xml))return void alert("Only numeric expressions can be storaged!!!")}r.removeChild(t[0]),CopyWholeExpresion(),isEditModeInputVar=!1,CopyVarInLocalStorage(),RenderOldExpression(),currIvar=-1}function CopyVarInLocalStorage(){if(storage){for(var e=new XMLSerializer,r=[],t=0;t<varNode_list.length;t++)r[t]=e.serializeToString(varNode_list[t]);storage.set("varNode_list",JSON.stringify(r)),storage.set("varLabel_list",JSON.stringify(varLabel_list)),storage.set("varType_list",JSON.stringify(varType_list))}for(var n=0;n<OrderIndexVarAndFun.length;n++)storage.set("OrderIndexVarAndFun",JSON.stringify(OrderIndexVarAndFun))}function SaveInputFun(e){var r=expr_xml.documentElement,t=r.childNodes;if(isScreenMode){if(t.length<=1)return void alert("There is no node to copy!!!");if(0!=expr_xml.querySelectorAll("[color]").length)return void alert("Only numeric expressions can be storaged!!!")}r.removeChild(t[0]),CopyFunctionExpression(),isParamListCreated=!1,isEditModeInputUserDefFun=!1,curr_UDF=-1,CopyUDFInLocalStorage(),RenderOldExpression()}function IsUDF_DefinitionActive(){var e=!1;return"inline-block"==$("#inputFun_div").css("display")&&(e=!0),e}function IsVar_DefinitionActive(){var e=!1;return"inline-block"==$("#inputVar_div").css("display")&&(e=!0),e}function CopyUDFInLocalStorage(){if(storage){for(var e=new XMLSerializer,r=[],t=0;t<userDefFunNode_list.length;t++)r[t]=e.serializeToString(userDefFunNode_list[t]);storage.set("userDefFunNode_list",JSON.stringify(r)),storage.set("userDefFunLabel_list",JSON.stringify(userDefFunLabel_list)),storage.set("userDefFunParamType_list",JSON.stringify(userDefFunParamType_list)),storage.set("userDefFunParamNames",JSON.stringify(userDefFunParamNames));for(var n=0;n<OrderIndexVarAndFun.length;n++)storage.set("OrderIndexVarAndFun",JSON.stringify(OrderIndexVarAndFun))}}function CancelInputVar(){if($("#inputVar_div").css("display","none"),$("#screenLine").css("padding","15px 5px"),!isEditModeInputVar){var e=varLabel_list[currIvar]+"_var",r=OrderIndexVarAndFun.indexOf(e);OrderIndexVarAndFun.splice(r,1),varNode_list.splice(currIvar,1),varLabel_list.splice(currIvar,1),varType_list.splice(currIvar,1)}DefineRowsHeight(),isEditModeInputVar=!1,RenderOldExpression(),currIvar=-1}function CancelInputFunName(){isScreenMode||ClearAll(),isScreenMode=!0,$("#bodyCalculator").show(),$("#bodyInputFunName").hide(),DefineRowsHeight(),Preview.UpdateCursorPosition(),-1!=curr_UDF&&(userDefFunNode_list.splice(curr_UDF,1),userDefFunLabel_list.splice(curr_UDF,1),userDefFunParamType_list.splice(curr_UDF,1),userDefFunParamNames.splice(curr_UDF,1)),$("#inputFun_div").css("display","none"),$("#screenLine").css("padding","15px 5px"),DefineRowsHeight(),RenderOldExpression(),isParamListCreated=!1,isInputUSFActivated=!1,curr_UDF=-1}function AcceptInputFunName(){if(isParamListCreated){d=parseFloat(document.getElementById("NumOfParams").value);var e=[],r=[];for(u=0;u<d;u++){var t="name_param_"+(m=u+1),n=document.getElementById(t).value,i="param_type_"+m,o=document.getElementById(i).value;if(""==n)return void alert("The parameters must have a name!!!");if(-1!=n.indexOf(" "))return void alert("White spaces in the name of the parameters is not allowed!!!");if(!n[0].match(/[a-z]/i)&&"&"!=n[0])return void alert("The name the parameters must begin with a letter!!!");e[e.length]=n,r[r.length]=o}for(u=0;u<d;u++){var a=e[u];if(e.indexOf(a)!=e.lastIndexOf(a))return void alert("The name of parameters can be repetead!!!")}var s=userDefFunLabel_list.length-1;userDefFunParamNames[s]=e,userDefFunParamType_list[s]=r,curr_UDF=s,$("#bodyInputFunName").hide(),$("#inputFun_div").css("display","inline-block"),$("#bodyCalculator").show(),DefineRowsHeight(),InsertUDF_Label(s),isInputUSFActivated=!1}else{var l=document.getElementById("fun_name_text").value;if(""==l)return void alert("The function must have a name!!!");if(-1!=userDefFunLabel_list.indexOf(l))return void alert("This name for the function already exists!!!");if(-1!=l.indexOf(" "))return void alert("White spaces in the name of the function is not allowed!!!");if(!l[0].match(/[a-z]/i))return void alert("The function name must begin with a letter!!!");for(var d=parseFloat(document.getElementById("NumOfParams").value),u=0;u<d;u++){var m,c="<hr class='hr_line'/><div class='name_parameter_label'><p><strong>Name parameter "+(m=u+1)+": </strong><input id='name_param_"+m+"' type='text' class='name_parameter' name='name_param_"+m+"' size='7'></p><div>";c+="<div class='type_parameter'><p><strong>Type:</strong><select name='ParamType' id='param_type_"+m+"' class='input_class' size='1'><option value='number' selected>Number</option><option value='vector'>Vector</option><option value='matrix'>Matrix</option></select></div>",$(btnCancelInputFunNameDiv).before(c)}userDefFunNode_list[userDefFunNode_list.length]="",userDefFunLabel_list[userDefFunLabel_list.length]=l,userDefFunParamType_list[userDefFunParamType_list.length]=[],userDefFunParamNames[userDefFunParamNames.length]=[];var p=l+"_udf";OrderIndexVarAndFun[OrderIndexVarAndFun.length]=p,isParamListCreated=!0}}function InsertUDF_Label(e){var r;r=expr_xml.documentElement;var t=expr_xml.createElement("mfenced");mfenced_cont++;var n=expr_xml.createAttribute("open");n.nodeValue="",t.setAttributeNode(n);var i=expr_xml.createAttribute("close");i.nodeValue="",t.setAttributeNode(i);var o=expr_xml.createAttribute("id"),a="mfenced_"+mfenced_cont;currId=a,o.nodeValue=a,t.setAttributeNode(o);var s=expr_xml.createAttribute("separators");s.nodeValue="",t.setAttributeNode(s);var l=expr_xml.createAttribute("type");l.nodeValue="non_erasable",t.setAttributeNode(l);var d=r.appendChild(t),u=expr_xml.createElement("mi"),m=expr_xml.createTextNode(userDefFunLabel_list[e]);u.appendChild(m);var c=expr_xml.createAttribute("type");c.nodeValue="non_searchable",u.setAttributeNode(c),(I=expr_xml.createAttribute("mathvariant")).nodeValue="italic",u.setAttributeNode(I);d.appendChild(u);var p=expr_xml.createElement("mfenced"),f=expr_xml.createAttribute("open");f.nodeValue="(",p.setAttributeNode(f);var x=expr_xml.createAttribute("close");x.nodeValue=")",p.setAttributeNode(x);var _=expr_xml.createAttribute("separators");_.nodeValue="",p.setAttributeNode(_);var v=expr_xml.createAttribute("type");v.nodeValue="non_searchable",p.setAttributeNode(v);for(var N=d.appendChild(p),b=0;b<userDefFunParamNames[e].length;b++){var g=expr_xml.createElement("mn"),h=expr_xml.createAttribute("type");h.nodeValue="non_searchable",g.setAttributeNode(h);var I,C=N.appendChild(g),A=userDefFunParamNames[e][b];if(IsGreekLetter(A)&&(A="&"+A+";"),"vector"==userDefFunParamType_list[e][b]||"matrix"==userDefFunParamType_list[e][b])(I=expr_xml.createAttribute("mathvariant")).nodeValue="bold",g.setAttributeNode(I);else(I=expr_xml.createAttribute("mathvariant")).nodeValue="italic",g.setAttributeNode(I);var y=expr_xml.createTextNode(A);C.appendChild(y);if(b<userDefFunParamNames[e].length-1){var V=expr_xml.createElement("mi"),S=N.appendChild(V),D=expr_xml.createTextNode(","),M=(S.appendChild(D),expr_xml.createAttribute("type"));M.nodeValue="non_searchable",V.setAttributeNode(M);S=N.appendChild(V)}}var F=expr_xml.createElement("mo"),P=expr_xml.createTextNode("=");F.appendChild(P);var E=expr_xml.createAttribute("type");E.nodeValue="non_searchable",F.setAttributeNode(E),t.appendChild(F),CursorPos=1,text_screen=xml_Serial.serializeToString(expr_xml),isZoomFrameRequired=!0,InputChanges()}function CancelInputVarName(){isScreenMode||ClearAll(),isScreenMode=!0,$("#bodyCalculator").show(),$("#bodyInputVarName").hide(),DefineRowsHeight(),RenderOldExpression()}function RenderOldExpression(){if(ClearAll(),expr_xml=expr_xml_old.cloneNode(!0),text_screen=xml_Serial.serializeToString(expr_xml),isScreenMode=isScreenMode_old,isScreenMode){var e=GetElementById(expr_xml,"root");if((e=UpdateIdOfNode(e)).hasChildNodes()){var r=e.lastChild;currId=r.getAttribute("id")}else currId=e.getAttribute("id");CursorPos=1,InputChanges()}else 0!=interval_var&&CloseInterval(),Preview.Update()}function AcceptInputVarName(){var e=document.getElementById("var_name_text").value,r=document.getElementById("var_type").value;if(""!=e)if(-1==varLabel_list.indexOf(e))if(-1==e.indexOf(" "))if(e[0].match(/[a-z]/i)){i_var=varNode_list.length,currIvar=i_var;var t=e+"_var";OrderIndexVarAndFun[OrderIndexVarAndFun.length]=t,varNode_list[varNode_list.length]="",varLabel_list[varLabel_list.length]=e,varType_list[varType_list.length]=r,$("#bodyInputVarName").hide(),$("#inputVar_div").css("display","inline-block"),$("#bodyCalculator").show(),DefineRowsHeight(),InsertVar_Label(i_var)}else alert("The var name must begin with a letter!!!");else alert("White spaces in the name of the variable is not allowed!!!");else alert("This name for the variable already exists!!!");else alert("The variable must have a name!!!")}function InsertVar_Label(e){var r;r=expr_xml.documentElement;var t=expr_xml.createElement("mfenced");mfenced_cont++;var n=expr_xml.createAttribute("open");n.nodeValue="",t.setAttributeNode(n);var i=expr_xml.createAttribute("close");i.nodeValue="",t.setAttributeNode(i);var o=expr_xml.createAttribute("id"),a="mfenced_"+mfenced_cont;currId=a,o.nodeValue=a,t.setAttributeNode(o);var s=expr_xml.createAttribute("separators");s.nodeValue="",t.setAttributeNode(s);var l=expr_xml.createAttribute("type");l.nodeValue="non_erasable",t.setAttributeNode(l);var d=r.appendChild(t),u=expr_xml.createElement("mi"),m=expr_xml.createTextNode(varLabel_list[e]);u.appendChild(m);var c=expr_xml.createAttribute("type");c.nodeValue="non_searchable",u.setAttributeNode(c);var p=expr_xml.createAttribute("mathvariant");"matrix"==varType_list[e]||"vector"==varType_list[e]?p.nodeValue="bold":p.nodeValue="normal",u.setAttributeNode(p);d.appendChild(u);var f=expr_xml.createElement("mo"),x=expr_xml.createTextNode("=");f.appendChild(x);var _=expr_xml.createAttribute("type");_.nodeValue="non_searchable",f.setAttributeNode(_),t.appendChild(f),CursorPos=1,text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}function IsGreekLetter(e){var r=!1;return-1!=Greek_Letter_list.indexOf(e)&&(r=!0),r}function ShowParamsMenu(){CloseSubMenus();var e=document.getElementById("MenuShowParams"),r=userDefFunParamNames[curr_UDF],t=userDefFunParamType_list[curr_UDF];e.innerHTML="";for(var n=0;n<r.length;n++){var i=r[n];IsGreekLetter(i)&&(i="&"+i+";");var o=t[n];e.innerHTML+="vector"==o||"matrix"==o?"<li><div onclick='InsertParam("+curr_UDF+","+n+")';><strong>"+i+"<strong></div></li>":"<li><div onclick='InsertParam("+curr_UDF+","+n+")';><i>"+i+"</i></div></li>"}$(e).show(),PositionateMenu("#btnShowParamsMenu","#MenuShowParams","drop-up-right")}function CancelInputFun(){if($("#inputFun_div").css("display","none"),$("#screenLine").css("padding","15px 5px"),DefineRowsHeight(),RenderOldExpression(),!isEditModeInputUserDefFun){var e=userDefFunLabel_list[curr_UDF]+"_udf",r=OrderIndexVarAndFun.indexOf(e);OrderIndexVarAndFun.splice(r,1),userDefFunNode_list.splice(curr_UDF,1),userDefFunLabel_list.splice(curr_UDF,1),userDefFunParamType_list.splice(curr_UDF,1),userDefFunParamNames.splice(curr_UDF,1)}isInputUSFActivated=!1,isParamListCreated=!1,isEditModeInputUserDefFun=!1,curr_UDF=-1}function BackInputFun(){$("#inputFun_div").css("display","none"),ClearAll(),CloseSubMenus(),ActiveBody("#bodyInputFunName");var e=document.getElementById("fun_name_text");document.getElementById("NumOfParams").selectedIndex=0,$(".name_parameter").remove(),$(".type_parameter").remove(),$(".name_parameter_label").remove(),$(".hr_line").remove(),isInputUSFActivated=!0,isParamListCreated=!1;var r=userDefFunLabel_list[curr_UDF]+"_udf",t=OrderIndexVarAndFun.indexOf(r);OrderIndexVarAndFun.splice(t,1),userDefFunNode_list.splice(curr_UDF,1),userDefFunLabel_list.splice(curr_UDF,1),userDefFunParamType_list.splice(curr_UDF,1),userDefFunParamNames.splice(curr_UDF,1),CopyUDFInLocalStorage(),e.focus()}function BackInputVar(){$("#inputVar_div").css("display","none"),ClearAll(),CloseSubMenus(),ActiveBody("#bodyInputVarName");var e=document.getElementById("var_name_text");document.getElementById("var_type").selectedIndex=0;var r=varLabel_list[currIvar]+"_var",t=OrderIndexVarAndFun.indexOf(r);OrderIndexVarAndFun.splice(t,1),varNode_list.splice(currIvar,1),varLabel_list.splice(currIvar,1),varType_list.splice(currIvar,1),CopyVarInLocalStorage(),e.focus(),isEditModeInputVar=!1}function InsertVarMenu(){CloseSubMenus();var e=document.getElementById("subMenuInsertVar");if(0==varLabel_list.length)e.innerHTML="<li><div>No variable to insert</div></li>";else{e.innerHTML="";for(var r=0;r<varLabel_list.length;r++){var t=varLabel_list[r];IsGreekLetter(t)&&(t="&"+t+";"),"matrix"==varType_list[r]?e.innerHTML+="<li><div onclick='InsertVar("+r+")';><strong>"+t+"<strong></div></li>":e.innerHTML+="<li><div onclick='InsertVar("+r+")';>"+t+"</div></li>"}}$(e).show(),PositionateMenu("#btnInsertVar","#subMenuInsertVar","move-left")}function InsertUserDefFunMenu(){CloseSubMenus();var e=document.getElementById("subMenuInsertUserDefFun");if(0==userDefFunLabel_list.length)e.innerHTML="<li><div>No func to insert</div></li>";else{e.innerHTML="";for(var r=0;r<userDefFunLabel_list.length;r++){var t=userDefFunLabel_list[r];e.innerHTML+="<li><div onclick='InsertUserDefFun("+r+")';>"+t+"</div></li>"}}$(e).show(),PositionateMenu("#btnInsertUserDefFun","#subMenuInsertUserDefFun","move-right")}function InsertVar(e){if(isScreenMode||ClearAll(),isScreenMode=!0,0!=varLabel_list.length&&"undefined"!=varLabel_list[e])if(e!=currIvar){var r,t,n,i=varLabel_list[e];if(isEditModeInputVar||isEditModeInputUserDefFun){var o=i+"_var",a=OrderIndexVarAndFun.indexOf(o);if(isEditModeInputVar){if(e==currIvar)return alert("In the edit mode the variable that is being edited can not be inserted!!!"),$("#subMenuInsertVar").css("display","none"),void $("#UserCreateVarsMenu").css("display","none");o=expr_xml.documentElement.firstChild.firstChild.firstChild.nodeValue+"_var";if(OrderIndexVarAndFun.indexOf(o)<=a)return alert("To avoid recursive definition, during the edition of a var defined earlier cannot be inserted vars defined later!!!"),$("#subMenuInsertVar").css("display","none"),void $("#UserCreateVarsMenu").css("display","none")}if(isEditModeInputUserDefFun){var s=expr_xml.documentElement.firstChild.firstChild.firstChild.nodeValue+"_udf";if(OrderIndexVarAndFun.indexOf(s)<=a)return alert("To avoid recursive definition, during the edition of a function defined earlier cannot be inserted vars defined later!!!"),$("#subMenuInsertVar").css("display","none"),void $("#UserCreateVarsMenu").css("display","none")}}var l=!1;if("root"!=currId){if(!(r=GetElementById(expr_xml,currId)))return;(IsExponentOfPower(r)||IsIndexOfRoot(r))&&(l=!0),n=r.parentNode,t=r.tagName,IsGreyColorNode(r)&&(t=(r=FindFirstCorrectNode(currId))?r.tagName:"")}else t="",n=expr_xml.documentElement;"mn"==t&&0==parseFloat(r.childNodes[0].nodeValue)&&(n.removeChild(r),t="");var d=expr_xml.createElement("mi"),u=i;IsGreekLetter(u)&&(u="&"+u+";");var m=expr_xml.createTextNode(u),c=expr_xml.createAttribute("id");mi_cont++,c.nodeValue="mi_"+mi_cont,d.appendChild(m),d.setAttributeNode(c);var p=expr_xml.createAttribute("type");p.nodeValue="var",d.setAttributeNode(p);var f=expr_xml.createAttribute("mathvariant");"matrix"==varType_list[e]?f.nodeValue="bold":f.nodeValue="normal",d.setAttributeNode(f);var x,_=n.appendChild(d);if(r){if(0==CursorPos)x=n.insertBefore(_,r),CursorPos=1;else if(1==CursorPos){var v=r.nextSibling;x=v?n.insertBefore(_,v):n.appendChild(_)}else if(.5==CursorPos&&(t="mn")){var N=r.childNodes[0].nodeValue,b=N.substring(0,NumDigitLeft);ChangeTextToMnNode(r,N.substring(NumDigitLeft,NumDigitLeft+NumDigitRight));var g=CreateMnElement(b);n.insertBefore(g,r);x=n.insertBefore(_,r)}}else if(IsMsup(n)||IsMroot(n))if(l)x=n.appendChild(_);else{var h=n.firstChild;x=n.insertBefore(_,h)}else x=n.appendChild(_);currId=x.getAttribute("id"),text_screen=xml_Serial.serializeToString(expr_xml),InputChanges(),$("#subMenuInsertVar").css("display","none"),$("#UserCreateVarsMenu").css("display","none")}else alert("During the definition of a variable can not be inserted the same variable!!!");else alert("There is no variable stored!!!")}function InsertParam(e,r){if(isScreenMode||ClearAll(),isScreenMode=!0,0!=userDefFunParamNames[e].length&&"undefined"!=userDefFunParamNames[e][r]){var t,n=null,i=!1;if("root"!=currId){if(!(n=GetElementById(expr_xml,currId)))return;(IsExponentOfPower(n)||IsIndexOfRoot(n))&&(i=!0),t=n.parentNode,currTag=n.tagName,IsGreyColorNode(n)&&(n=FindFirstCorrectNode(currId),currTag=n?n.tagName:"")}else currTag="",t=expr_xml.documentElement;"mn"==currTag&&0==parseFloat(n.childNodes[0].nodeValue)&&(t.removeChild(n),currTag="");var o=expr_xml.createElement("mi"),a=userDefFunParamNames[e][r];IsGreekLetter(a)&&(a="&"+a+";");var s=expr_xml.createTextNode(a),l=expr_xml.createAttribute("id");mi_cont++,l.nodeValue="mi_"+mi_cont,o.appendChild(s),o.setAttributeNode(l);var d=expr_xml.createAttribute("type");d.nodeValue="param",o.setAttributeNode(d);var u=expr_xml.createAttribute("param_type"),m=userDefFunParamType_list[e][r];u.nodeValue=m,o.setAttributeNode(u);var c=expr_xml.createAttribute("mathvariant");"vector"==userDefFunParamType_list[e][r]||"matrix"==userDefFunParamType_list[e][r]?c.nodeValue="bold":c.nodeValue="italic",o.setAttributeNode(c);var p,f=t.appendChild(o);if(n){if(0==CursorPos)p=t.insertBefore(f,n);else if(1==CursorPos){var x=n.nextSibling;p=x?t.insertBefore(f,x):t.appendChild(f)}else if(.5==CursorPos&&(currTag="mn")){var _=n.childNodes[0].nodeValue,v=_.substring(0,NumDigitLeft);ChangeTextToMnNode(n,_.substring(NumDigitLeft,NumDigitLeft+NumDigitRight));var N=CreateMnElement(v);t.insertBefore(N,n);p=t.insertBefore(f,n)}}else if(IsMsup(t)||IsMroot(t))if(i)p=t.appendChild(f);else{var b=t.firstChild;p=t.insertBefore(f,b)}else p=t.appendChild(f);currId=p.getAttribute("id"),text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}else alert("There is no parameter stored!!!")}function InsertUserDefFun(e){if(isScreenMode||ClearAll(),isScreenMode=!0,0!=userDefFunLabel_list.length&&"undefined"!=userDefFunLabel_list[e])if(e!=curr_UDF||-1==curr_UDF){var r,t,n,i=userDefFunLabel_list[e];if(isEditModeInputVar||isEditModeInputUserDefFun){var o=i+"_udf",a=OrderIndexVarAndFun.indexOf(o);if(isEditModeInputVar){var s=expr_xml.documentElement.firstChild.firstChild.firstChild.nodeValue+"_var";if(OrderIndexVarAndFun.indexOf(s)<=a)return alert("To avoid recursive definition, during the edition of a var defined earlier cannot be inserted functions defined later!!!"),$("#subMenuInsertVar").css("display","none"),void $("#UserCreateVarsMenu").css("display","none")}if(isEditModeInputUserDefFun){if(e==curr_UDF)return alert("In the edit mode the function that is being edited can not be inserted!!!"),$("#subMenuInsertVar").css("display","none"),void $("#UserCreateVarsMenu").css("display","none");o=expr_xml.documentElement.firstChild.firstChild.firstChild.nodeValue+"_udf";if(OrderIndexVarAndFun.indexOf(o)<=a)return alert("To avoid recursive definition, during the edition of a function defined earlier cannot be inserted functions defined later!!!"),$("#subMenuInsertVar").css("display","none"),void $("#UserCreateVarsMenu").css("display","none")}}var l=!1;if("root"!=currId){if(!(r=GetElementById(expr_xml,currId)))return;(IsExponentOfPower(r)||IsIndexOfRoot(r))&&(l=!0),n=r.parentNode,t=r.tagName,IsGreyColorNode(r)&&(t=(r=FindFirstCorrectNode(currId))?r.tagName:"")}else t="",n=expr_xml.documentElement;"mn"==t&&0==parseFloat(r.childNodes[0].nodeValue)&&(n.removeChild(r),t="");var d=expr_xml.createElement("mfenced");mfenced_cont++;var u=expr_xml.createAttribute("open");u.nodeValue="",d.setAttributeNode(u);var m=expr_xml.createAttribute("close");m.nodeValue="",d.setAttributeNode(m);var c=expr_xml.createAttribute("id"),p="mfenced_"+mfenced_cont;c.nodeValue=p,d.setAttributeNode(c);var f,x=expr_xml.createAttribute("separators");if(x.nodeValue="",d.setAttributeNode(x),r){if(0==CursorPos)f=n.insertBefore(d,r);else if(1==CursorPos){var _=r.nextSibling;f=_?n.insertBefore(d,_):n.appendChild(d)}else if(.5==CursorPos&&(t="mn")){var v=r.childNodes[0].nodeValue,N=v.substring(0,NumDigitLeft);ChangeTextToMnNode(r,v.substring(NumDigitLeft,NumDigitLeft+NumDigitRight));var b=CreateMnElement(N);n.insertBefore(b,r);f=n.insertBefore(d,r)}}else if(IsMsup(n)||IsMroot(n))if(l)f=n.appendChild(d);else{var g=n.lastChild;f=n.insertBefore(d,g)}else f=n.appendChild(d);var h=expr_xml.createElement("mi"),I=expr_xml.createTextNode(userDefFunLabel_list[e]),C=expr_xml.createAttribute("id");mi_cont++,C.nodeValue="mi_"+mi_cont,h.appendChild(I),h.setAttributeNode(C);var A=expr_xml.createAttribute("type");A.nodeValue="udf",h.setAttributeNode(A),(B=expr_xml.createAttribute("mathvariant")).nodeValue="italic",h.setAttributeNode(B);f.appendChild(h);var y=expr_xml.createElement("mfenced");mfenced_cont++;var V=expr_xml.createAttribute("open");V.nodeValue="(",y.setAttributeNode(V);var S=expr_xml.createAttribute("close");S.nodeValue=")",y.setAttributeNode(S);var D=expr_xml.createAttribute("id"),M="mfenced_"+mfenced_cont;D.nodeValue=M,y.setAttributeNode(D);var F=expr_xml.createAttribute("separators");F.nodeValue="",y.setAttributeNode(F);for(var P=f.appendChild(y),E=0;E<userDefFunParamNames[e].length;E++){var L=expr_xml.createElement("mn"),T=expr_xml.createAttribute("id"),w="mn_"+ ++mn_cont;0==E&&(currId=w),T.nodeValue=w,L.setAttributeNode(T);var O=expr_xml.createAttribute("color");O.nodeValue="#A4A4A4",L.setAttributeNode(O);var U=expr_xml.createAttribute("type");U.nodeValue="param",L.setAttributeNode(U);var B,G=P.appendChild(L),R=userDefFunParamNames[e][E];if(IsGreekLetter(R)&&(R="&"+R+";"),"vector"==userDefFunParamType_list[e][E]||"matrix"==userDefFunParamType_list[e][E])(B=expr_xml.createAttribute("mathvariant")).nodeValue="bold",L.setAttributeNode(B);else(B=expr_xml.createAttribute("mathvariant")).nodeValue="italic",L.setAttributeNode(B);var k=expr_xml.createTextNode(R);G.appendChild(k);if(E<userDefFunParamNames[e].length-1){var z=expr_xml.createElement("mi"),H=P.appendChild(z),q=expr_xml.createTextNode(","),J=(H.appendChild(q),expr_xml.createAttribute("type"));J.nodeValue="coma",z.setAttributeNode(J);H=P.appendChild(z)}}UDF_cont++,CursorPos=1,text_screen=xml_Serial.serializeToString(expr_xml),InputChanges(),$("#subMenuInsertUserDefFun").css("display","none"),$("#UserDefFunMenu").css("display","none")}else alert("During the definition of a function can not be inserted the same function!!!");else alert("There is no function stored!!!")}function ReplaceNode_from_VarNode_List(e,r,t){if(isScreenMode||ClearAll(),isScreenMode=!0,varNode_list[e]){var n=varNode_list[e].cloneNode(!0);if(newNodeId=n.getAttribute("id"),"root"==newNodeId){var i=expr_xml.createElement("mfenced");mfenced_cont++;var o=expr_xml.createAttribute("open");o.nodeValue="(",i.setAttributeNode(o);var a=expr_xml.createAttribute("close");a.nodeValue=")",i.setAttributeNode(a);var s=expr_xml.createAttribute("id"),l="mfenced_"+mfenced_cont;s.nodeValue=l,i.setAttributeNode(s);var d=expr_xml.createAttribute("separators");d.nodeValue="",i.setAttributeNode(d);for(var u=t.insertBefore(i,r),m=n.childNodes,c=0;c<m.length;c++)if(IsVarMiNode(m[c])){var p=m[c].childNodes[0].nodeValue,f=varLabel_list.indexOf(p),x=m[c].cloneNode(!0);ReplaceNode_from_VarNode_List(f,_=u.appendChild(x),u)}else{for(var _,v=(_=m[c].cloneNode(!0)).querySelectorAll("mi"),N=0;N<v.length;N++){var b=v[N].childNodes[0].nodeValue;if(IsVarLabel(b)&&IsVarMiNode(v[N])){e=varLabel_list.indexOf(b);var g=v[N].parentNode;ReplaceNode_from_VarNode_List(e,v[N],g)}else IsUDFLabel(b)&&ReplaceUDFMiNode(v[N])}u.appendChild(_)}t.removeChild(r)}else t.insertBefore(n,r),t.removeChild(r)}else alert("There is no variable stored!!!")}function IsSecondaryVarNode(e){is_SecondaryVarNode=!1;for(var r=e.getElementsByTagName("mi"),t=0;t<r.length;t++)if(IsVarMiNode(r[t])){is_SecondaryVarNode=!0;break}return is_SecondaryVarNode}function EditVarMenu(){CloseSubMenus();var e=document.getElementById("subMenuEditVar");if(0==varLabel_list.length)e.innerHTML="<li><div>No variable to edit</div></li>";else{e.innerHTML="";for(var r=0;r<varLabel_list.length;r++){var t=varLabel_list[r];IsGreekLetter(t)&&(t="&"+t+";"),"matrix"==varType_list[r]?e.innerHTML+="<li><div onclick='EditVar("+r+")';><strong>"+t+"<strong></div></li>":e.innerHTML+="<li><div onclick='EditVar("+r+")';>"+t+"</div></li>"}}$(e).show(),PositionateMenu("#btnEditVar","#subMenuEditVar","move-left")}function EditVar(e){if(isEditModeInputVar)alert("It can not be edited a variable during the definition of another!!!");else{if(IsVar_DefinitionActive()||IsUDF_DefinitionActive())return $("#subMenuEditVar").css("display","none"),$("#UserCreateVarsMenu").css("display","none"),void alert("During var or function definition cannot be edited any var!!!");expr_xml_old=expr_xml.cloneNode(!0),isScreenMode_old=isScreenMode,ClearAll(),CloseSubMenus(),$("#inputVar_div").css("display","inline-block"),DefineRowsHeight(),document.getElementById("var_name_text").value=varLabel_list[e],InsertVar_Label(e);for(var r=GetElementById(expr_xml,"root"),t=varNode_list[e].cloneNode(!0).childNodes,n=0;n<t.length;n++){var i=t[n].cloneNode(!0);i=UpdateIdOfNode(i),r.appendChild(i)}var o=r.lastChild;currId=o.getAttribute("id"),text_screen=xml_Serial.serializeToString(expr_xml),InputChanges(),isEditModeInputVar=!0,currIvar=e,$("#subMenuEditVar").css("display","none"),$("#UserCreateVarsMenu").css("display","none")}}function EditUserDefFunMenu(){CloseSubMenus();var e=document.getElementById("subMenuEditUserDefFun");if(0==userDefFunLabel_list.length)e.innerHTML="<li><div>No func to edit</div></li>";else{e.innerHTML="";for(var r=0;r<userDefFunLabel_list.length;r++){var t=userDefFunLabel_list[r];e.innerHTML+="<li><div onclick='EditUserDefFun("+r+")';>"+t+"</div></li>"}}$(e).show(),PositionateMenu("#btnEditUserDefFun","#subMenuEditUserDefFun","move-right")}function EditUserDefFun(e){if(IsVar_DefinitionActive()||IsUDF_DefinitionActive())return $("#subMenuEditUserDefFun").css("display","none"),$("#UserDefFunMenu").css("display","none"),void alert("During var or function definition cannot be edited any function!!!");if(expr_xml_old=expr_xml.cloneNode(!0),isScreenMode_old=isScreenMode,ClearAll(),CloseSubMenus(),!IsVar_DefinitionActive()){$("#inputFun_div").css("display","inline-block"),DefineRowsHeight(),InsertUDF_Label(e);for(var r=GetElementById(expr_xml,"root"),t=userDefFunNode_list[e].cloneNode(!0).childNodes,n=0;n<t.length;n++){var i=t[n].cloneNode(!0);i=UpdateIdOfNode(i),r.appendChild(i)}for(var o=r.querySelectorAll("mi[type='param']"),a=0;a<o.length;a++){var s=o[a].childNodes[0].nodeValue;IsGreekLetter(s)&&(s="&"+s+";",o[a].childNodes[0].nodeValue=s)}var l=r.lastChild;currId=l.getAttribute("id"),text_screen=xml_Serial.serializeToString(expr_xml),InputChanges(),isEditModeInputUserDefFun=!0,curr_UDF=e,$("#subMenuEditUserDefFun").css("display","none"),$("#UserDefFunMenu").css("display","none")}}function DeleteVarMenu(){CloseSubMenus();var e=document.getElementById("subMenuDeleteVar");if(0==varLabel_list.length)e.innerHTML="<li><div>No variable to delete</div></li>";else{e.innerHTML="";for(var r=0;r<varLabel_list.length;r++){var t=varLabel_list[r];IsGreekLetter(t)&&(t="&"+t+";"),"matrix"==varType_list[r]?e.innerHTML+="<li><div onclick='DeleteVarConfirmation("+r+")';><strong>"+t+"<strong></div></li>":e.innerHTML+="<li><div onclick='DeleteVarConfirmation("+r+")';>"+t+"</div></li>"}}$(e).show(),PositionateMenu("#btnDeleteVar","#subMenuDeleteVar","move-left")}function DeleteVarConfirmation(e){if(IsVar_DefinitionActive()||IsUDF_DefinitionActive())return $("#subMenuDeleteVar").css("display","none"),$("#UserCreateVarsMenu").css("display","none"),void alert("During var or function definition cannot be deleted any var!!!");var r=varLabel_list[e];1==confirm("Are you sure to delete var: "+r+" ?")?DeleteVar(e):($("#subMenuDeleteVar").css("display","none"),$("#UserCreateVarsMenu").css("display","none"))}function DeleteVar(e){if(isEditModeInputVar)alert("It can not be delete a variable during the definition of another!!!");else{var r=varLabel_list[e]+"_var",t=OrderIndexVarAndFun.indexOf(r);OrderIndexVarAndFun.splice(t,1),varNode_list.splice(e,1),varLabel_list.splice(e,1),varType_list.splice(e,1),$("#subMenuDeleteVar").css("display","none"),$("#UserCreateVarsMenu").css("display","none"),CopyVarInLocalStorage()}}function DeleteAllVarConfirmation(){if(IsVar_DefinitionActive()||IsUDF_DefinitionActive())return $("#subMenuDeleteVar").css("display","none"),$("#UserCreateVarsMenu").css("display","none"),void alert("During var or function definition cannot be deleted any var!!!");if(isEditModeInputVar)alert("It can not be edited a variable during the definition of another!!!");else{if(0!=varNode_list.length){1==confirm("Are you sure to delete the all stored vars?")&&DeleteAllVar()}for(var e=0;e<varLabel_list.length;e++){var r=varLabel_list[e]+"_var",t=OrderIndexVarAndFun.indexOf(r);OrderIndexVarAndFun.splice(t,1)}varNode_list=[],varLabel_list=[],varType_list=[],CopyVarInLocalStorage(),$("#subMenuDeleteVar").css("display","none"),$("#UserCreateVarsMenu").css("display","none")}}function DeleteAllVar(){for(var e=0;e<varLabel_list.length;e++){var r=varLabel_list[e]+"_var",t=OrderIndexVarAndFun.indexOf(r);OrderIndexVarAndFun.splice(t,1)}varNode_list=[],varLabel_list=[],varType_list=[],CopyVarInLocalStorage(),$("#subMenuDeleteVar").css("display","none"),$("#UserCreateVarsMenu").css("display","none")}function DeleteUserDefFunMenu(){CloseSubMenus();var e=document.getElementById("subMenuDeleteUserDefFun");if(0==userDefFunLabel_list.length)e.innerHTML="<li><div>No func to delete</div></li>";else{e.innerHTML="";for(var r=0;r<userDefFunLabel_list.length;r++){var t=userDefFunLabel_list[r];e.innerHTML+="<li><div onclick='DeleteUserDefFunConfirmation("+r+")';>"+t+"</div></li>"}}$(e).show(),PositionateMenu("#btnDeleteUserDefFun","#subMenuDeleteUserDefFun","move-right")}function DeleteUserDefFunConfirmation(e){if(IsVar_DefinitionActive()||IsUDF_DefinitionActive())return $("#subMenuDeleteUserDefFun").css("display","none"),$("#UserDefFunMenu").css("display","none"),void alert("During var or function definition cannot be deleted any function!!!");var r=userDefFunLabel_list[e];1==confirm("Are you sure to delete function: "+r+" ?")?DeleteUserDefFun(e):($("#inputFun_div").css("display","none"),$("#screenLine").css("padding","15px 5px"),DefineRowsHeight(),Preview.UpdateCursorPosition(),isParamListCreated=!1,isInputUSFActivated=!1,$("#subMenuDeleteUserDefFun").css("display","none"),$("#UserDefFunMenu").css("display","none"))}function DeleteUserDefFun(e){var r=userDefFunLabel_list[curr_UDF]+"_udf",t=OrderIndexVarAndFun.indexOf(r);OrderIndexVarAndFun.splice(t,1),userDefFunNode_list.splice(e,1),userDefFunLabel_list.splice(e,1),userDefFunParamType_list.splice(e,1),userDefFunParamNames.splice(e,1),$("#inputFun_div").css("display","none"),$("#screenLine").css("padding","15px 5px"),DefineRowsHeight(),Preview.UpdateCursorPosition(),isParamListCreated=!1,isInputUSFActivated=!1,$("#subMenuDeleteUserDefFun").css("display","none"),$("#UserDefFunMenu").css("display","none"),CopyUDFInLocalStorage()}function DeleteAllUserDefFun(e){for(e=0;e<userDefFunLabel_list.length;e++){var r=userDefFunLabel_list[e]+"_udf",t=OrderIndexVarAndFun.indexOf(r);OrderIndexVarAndFun.splice(t,1)}userDefFunNode_list=[],userDefFunLabel_list=[],userDefFunParamType_list=[],userDefFunParamNames=[],CopyUDFInLocalStorage(),$("#inputFun_div").css("display","none"),$("#screenLine").css("padding","15px 5px"),DefineRowsHeight(),Preview.UpdateCursorPosition(),isParamListCreated=!1,isInputUSFActivated=!1,$("#subMenuDeleteUserDefFun").css("display","none"),$("#UserDefFunMenu").css("display","none")}function DeleteAllUserDefFunConfirmation(){if(IsVar_DefinitionActive()||IsUDF_DefinitionActive())return $("#subMenuDeleteUserDefFun").css("display","none"),$("#UserDefFunMenu").css("display","none"),void alert("During var or function definition cannot be deleted any function!!!");if(0!=userDefFunNode_list.length){if(1==confirm("Are you sure to delete all the stored functions?"))return void DeleteAllUserDefFun()}userDefFunNode_list=[],userDefFunLabel_list=[],userDefFunParamType_list=[],userDefFunParamNames=[],CopyUDFInLocalStorage(),$("#inputFun_div").css("display","none"),$("#screenLine").css("padding","15px 5px"),DefineRowsHeight(),Preview.UpdateCursorPosition(),isParamListCreated=!1,isInputUSFActivated=!1,$("#subMenuDeleteUserDefFun").css("display","none"),$("#UserDefFunMenu").css("display","none")}function ConfigList(){$("#ConfigListMenu").show(),PositionateMenu("#btnConfig","#ConfigListMenu","drop-down")}function PositionateMenu(e,r,t){if("block"===$(r).css("display")){$(r).css("left",0),$(r).css("top",0);var n,i,o=$(r).outerWidth(),a=$(r).height(),s=$(e).offset(),l=$(e).outerWidth(),d=$(e).outerHeight();if("drop-down"==t)n=s.left+l-o,i=s.top+d+2;else if("drop-up"==t){if(n=s.left+l-o,(i=s.top-a-5)<10){var u=s.top-15;$(r).css("max-height",u),i=10}}else if("drop-up-right"==t){if(n=s.left,(i=s.top-a-5)<10){u=s.top-15;$(r).css("max-height",u),i=10}}else if("move-left"==t){if(n=s.left-o-6,(i=s.top+d-a-5)<10){u=s.top+d-15;$(r).css("max-height",u),i=10}}else if("move-right"==t&&(n=s.left+l+5,(i=s.top+d-a)<10)){u=s.top+d-10;$(r).css("max-height",u),i=10}$(r).css("left",n),$(r).css("top",i)}}function CreateUserDefFunMenu(){var e=document.getElementById("UserDefFunMenu");$(e).show(),PositionateMenu("#btnUserDefFun","#UserDefFunMenu","drop-up-right")}function InsertFun(e){$("#LibFunListMenu").css("display","none"),GenericFunction(e)}function IsImaginarySymbol(e){if(!e)return!1;var r=!1;return"i"==e.firstChild.nodeValue&&(r=!0),r}function inputNumber(e){isScreenMode||ClearAll(),isScreenMode=!0;var r,t,n,i=null,o=!1;if("root"!=currId){if(!(i=GetElementById(expr_xml,currId)))return;(IsExponentOfPower(i)||IsIndexOfRoot(i))&&(o=!0),t=i.parentNode,r=i.tagName,IsGreyColorNode(i)&&(r=(i=FindFirstCorrectNode(currId))?i.tagName:"")}else r="",t=expr_xml.documentElement;if("mn"!=r||"i"==e){var a=expr_xml.createElement("mn");"."==e&&(e="0.");var s=expr_xml.createTextNode(e),l=expr_xml.createAttribute("id");if(mn_cont++,l.nodeValue="mn_"+mn_cont,a.appendChild(s),a.setAttributeNode(l),"i"==e){var d=expr_xml.createAttribute("mathvariant");d.nodeValue="italic",a.setAttributeNode(d)}if(i)if(0==CursorPos)n=t.insertBefore(a,i);else{var u=i.nextSibling;n=u?t.insertBefore(a,u):t.appendChild(a)}else if(IsMsup(t)||IsMroot(t))if(o)n=t.appendChild(a);else{var m=t.lastChild;n=t.insertBefore(a,m)}else n=t.appendChild(a);if(n.previousSibling&&!o){var c=n.previousSibling;"mn"!=c.tagName||IsImaginarySymbol(n)||(n=JointMnNodes(c,n))}currId=n.getAttribute("id"),CursorPos=1}else{var p=i.childNodes[0].nodeValue;if(0!=searchCharacter(p,".")&&"."==e)return;if(0!=CursorPos&&"0"==p&&"."!=e&&(p=""),CursorPos<1)0==CursorPos&&(NumDigitLeft=0,NumDigitRight=p.length),s=p.substring(0,NumDigitLeft)+e+p.substring(NumDigitLeft,NumDigitLeft+NumDigitRight),NumDigitLeft+=e.length,CursorPos=0==NumDigitLeft?0:.5;else s=p+e,CursorPos=1;i.childNodes[0].nodeValue=s}text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}function JointMnNodes(e,r){var t=e.parentNode,n=e.childNodes[0].nodeValue,i=r.childNodes[0].nodeValue,o=n+i;return e.childNodes[0].nodeValue=o,t.removeChild(r),NumDigitLeft=n.length,NumDigitRight=i.length,CursorPos=.5,e}function CreateMnElement(e){var r=expr_xml.createElement("mn"),t=expr_xml.createTextNode(e),n=expr_xml.createAttribute("id"),i="mn_"+ ++mn_cont;return n.nodeValue=i,r.appendChild(t),r.setAttributeNode(n),r}function CreateMnNode(e,r,t){var n=CreateMnElement(e);t?r.insertBefore(n,t):r.appendChild(n)}function CreateMfracNode(e,r,t,n){var i,o=expr_xml.createElement("mfrac"),a=expr_xml.createAttribute("id"),s="mfrac_"+ ++mfrac_cont;return a.nodeValue=s,o.setAttributeNode(a),(i=n?t.insertBefore(o,n):t.appendChild(o)).appendChild(e),i.appendChild(r),i}function CreateOperatorNode(e,r,t){var n=expr_xml.createElement("mo"),i=expr_xml.createTextNode(e),o=expr_xml.createAttribute("id"),a="mo_"+ ++mo_cont;return o.nodeValue=a,n.appendChild(i),n.setAttributeNode(o),t?r.insertBefore(n,t):r.appendChild(n)}function CreateExternalParenthesisNode(e){var r=expr_xml.createElement("mfenced");mfenced_cont++;var t=expr_xml.createAttribute("open");t.nodeValue="(",r.setAttributeNode(t);var n=expr_xml.createAttribute("close");n.nodeValue=")",r.setAttributeNode(n);var i=expr_xml.createAttribute("id"),o="mfenced_"+mfenced_cont;i.nodeValue=o,r.setAttributeNode(i);var a=expr_xml.createAttribute("separators");a.nodeValue="",r.setAttributeNode(a);var s=e.parentNode,l=e.cloneNode(!0);return s.insertBefore(r,e).appendChild(l),s.removeChild(e),r}function ChangeTextToMnNode(e,r){e.childNodes[0].nodeValue=r}function inputOperator(e){isScreenMode||ClearAll(),isScreenMode=!0;var r,t,n=null,i=!1;if("root"!=currId){if(!(n=GetElementById(expr_xml,currId)))return;if(t=n.parentNode,IsGreyColorNode(n)&&IsMsupOrMrootSonNode(n)&&(i=!0,"⋅"!=e&&"∧"!=e&&"⊗"!=e&&":"!=e||(t=CreateExternalParenthesisNode(n))),(!IsThereAnyCorrectNode(t)||i||IsNonErasebleNode(n))&&("+"==e||"-"==e||"×"==e))return void alert("The expression can not start with an operator!!!");r=n.tagName,IsGreyColorNode(n)&&(r=(n=FindFirstCorrectNode(currId))?n.tagName:"")}else{if("⋅"!=e&&"∧"!=e&&"⊗"!=e&&":"!=e)return void alert("The expression can not start with an operator!!!");t=expr_xml.documentElement}if("root"==currId||!IsThereAnyCorrectNode(t)||i||IsNonErasebleNode(n)){var o,a;switch(e){case"⋅":case"∧":case"⊗":o="a",a="b";break;case":":o="A",a="B"}var s=expr_xml.createElement("mn"),l=expr_xml.createAttribute("id"),d="mn_"+ ++mn_cont;currId=d,l.nodeValue=d,s.setAttributeNode(l),(v=expr_xml.createAttribute("color")).nodeValue="#A4A4A4",s.setAttributeNode(v);var u=t.appendChild(s),m=expr_xml.createAttribute("mathvariant");m.nodeValue="bold",s.setAttributeNode(m);var c=expr_xml.createTextNode(o),p=(u.appendChild(c),expr_xml.createElement("mo")),f=expr_xml.createTextNode(e),x=expr_xml.createAttribute("id"),_="mo_"+ ++mo_cont;x.nodeValue=_,p.appendChild(f),p.setAttributeNode(x),t.appendChild(p);var v,N=expr_xml.createElement("mn"),b=expr_xml.createAttribute("id"),g="mn_"+ ++mn_cont;b.nodeValue=g,N.setAttributeNode(b),(v=expr_xml.createAttribute("color")).nodeValue="#A4A4A4",N.setAttributeNode(v);var h=t.appendChild(N),I=expr_xml.createAttribute("mathvariant");I.nodeValue="bold",N.setAttributeNode(I);var C=expr_xml.createTextNode(a);h.appendChild(C);CursorPos=1,text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}else if("mo"!=r){p=expr_xml.createElement("mo"),f=expr_xml.createTextNode(e),x=expr_xml.createAttribute("id");if(currId="mo_"+ ++mo_cont,x.nodeValue=currId,p.appendChild(f),p.setAttributeNode(x),n){if(0==CursorPos)t.insertBefore(p,n);else if(1==CursorPos)if(IsMsupOrMrootSonNode(n)){CreateExternalParenthesisNode(n).appendChild(p)}else{var A=n.nextSibling;A?t.insertBefore(p,A):t.appendChild(p)}else if(.5==CursorPos&&(r="mn")){var y=n.childNodes[0].nodeValue,V=y.substring(0,NumDigitLeft);ChangeTextToMnNode(n,y.substring(NumDigitLeft,NumDigitLeft+NumDigitRight));var S=CreateMnElement(V);t.insertBefore(S,n);t.insertBefore(p,n)}}else t.appendChild(p);CursorPos=1,text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}else alert("Two followed operators are not allowed!!!")}function CreateSymbolicArgumentNode(e,r){var t=e.parentNode,n=!1;(IsExponentOfPower(e)||IsIndexOfRoot(e))&&(n=!0);var i=!1;if(IsDetArgument(e)||IsEigvArgument(e))r="A";else if(IsParamOfUDF(e)){var o=GiveParamName(e);r=o.Name,"number"!=o.Type&&(i=!0)}var a=expr_xml.createElement("mn"),s=expr_xml.createAttribute("id"),l="mn_"+ ++mn_cont;s.nodeValue=l,a.setAttributeNode(s);var d=expr_xml.createAttribute("color");d.nodeValue="#A4A4A4",a.setAttributeNode(d);var u,m=expr_xml.createAttribute("mathvariant");if(IsLinSolveArgument(e)?(t.firstChild==e?r="A":t.lastChild==e&&(r="b"),m.nodeValue="bold"):m.nodeValue="A"==r||i?"bold":"italic",a.setAttributeNode(m),"msup"==t.tagName||"mroot"==t.tagName)n?u=t.appendChild(a):(lastChild=t.lastChild,u=t.insertBefore(a,lastChild));else if(IsLinSolveArgument(e))if(t.firstChild==e){var c=e.nextSibling;u=t.insertBefore(a,c)}else t.lastChild==e&&(u=t.appendChild(a));else if(IsParamOfUDF(e))if(t.lastChild==e)u=t.appendChild(a);else{c=e.nextSibling;u=t.insertBefore(a,c)}else u=t.appendChild(a);var p=expr_xml.createTextNode(r);n&&(p.nodeValue="y");u.appendChild(p);currId=l}function Backspace(){if(currId&&"root"!=currId){var e,r=GetElementById(expr_xml,currId),t="";if(r&&(t=r.tagName,e=r.parentNode,!IsNonErasebleNode(r))){if("mn"!=t){if("#A4A4A4"==r.getAttribute("color"))currId=e.getAttribute("id"),CursorPos=1;else if(IsInverseOrTransposeGrandSonNode(r))CreateSymbolicArgumentNode(r,"A"),e.removeChild(r),CursorPos=1;else if((s=r.previousSibling)&&!IsMsupOrMrootSonNode(r)){var n=s.tagName,i="";(u=r.nextSibling)&&(i=u.tagName),"mn"!=n||"mn"!=i||IsImaginarySymbol(u)?IsNecesaryCreateSymbolicArgument(r)?CreateSymbolicArgumentNode(r,"x"):(currId=s.getAttribute("id"),CursorPos=1):(s=JointMnNodes(s,u),currId=s.getAttribute("id")),e.removeChild(r)}else{if("root"!=(m=e.getAttribute("id")))(u=r.nextSibling)&&!IsCommaNode(u)?(currId=u.getAttribute("id"),CursorPos=0):(IsNecesaryCreateSymbolicArgument(r)?CreateSymbolicArgumentNode(r,"x"):currId=e.getAttribute("id"),CursorPos=1),e.removeChild(r);else 1==CursorPos&&(e.removeChild(r),currId=e.getAttribute("id"))}}else{if(IsGreyColorNode(r)){if("mtd"==e.tagName&&!IsEexPreviousNode(r))return;if(!IsEexPreviousNode(r)){if(IsFunctionArgumentNode(r)||IsInverseOrTransposeGrandSonNode(r))e=e.parentNode,currId=e.getAttribute("id");else{var o=e.getAttribute("id");"root"!=o&&(currId=o)}return CursorPos=1,text_screen=xml_Serial.serializeToString(expr_xml),void InputChanges()}}var a=r.childNodes[0].nodeValue;if(0==CursorPos)if(r.previousSibling){var s=r.previousSibling;currId=s.getAttribute("id"),CursorPos=1,Backspace()}else currId=e.getAttribute("id"),CursorPos=1;else if(.5==CursorPos){var l=a.substring(NumDigitLeft,NumDigitLeft+NumDigitRight);NumDigitLeft--;var d=a.substring(0,NumDigitLeft);if(a=d+l,0==NumDigitLeft)if(r.previousSibling){s=r.previousSibling;currId=s.getAttribute("id"),CursorPos=1}else CursorPos=0;else CursorPos=.5}else if(1==CursorPos){if(0!=searchCharacter(a=a.substr(0,a.length-1),"e"))"e"==a.substr(a.length-1,a.length-1)&&(a=a.substr(0,a.length-1)),"e-"==a.substr(a.length-2,a.length-1)&&(a=a.substr(0,a.length-2));CursorPos=1}if(0==a.length){s=r.previousSibling;if((IsExponentOfPower(r)||IsIndexOfRoot(r))&&(s=null),"mtd"!=e.tagName||IsEexPreviousNode(r)){if(s&&!IsCommaNode(s))currId=s.getAttribute("id");else{var u,m=e.getAttribute("id");if(IsNecesaryCreateSymbolicArgument(r))CreateSymbolicArgumentNode(r,"x");else(u=r.nextSibling)?(currId=u.getAttribute("id"),CursorPos=0):currId=m}if(IsGreyColorNode(r)&&IsEexPreviousNode(r)){var c=s.childNodes[0].nodeValue;s.childNodes[0].nodeValue=c.substr(0,c.length-1)}e.removeChild(r)}else r.childNodes[0].nodeValue="0"}else r.childNodes[0].nodeValue=a}text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}}}function Supr(){if(currId&&"root"!=currId){var e=GetElementById(expr_xml,currId);if(e){1==CursorPos&&(e=e.nextSibling)&&(CursorPos=0);var r="";if(e){IsCommaNode(e)&&(e=e.previousSibling),r=e.tagName;var t=e.parentNode,n=null;if("mn"!=r)if("#A4A4A4"==e.getAttribute("color"))currId=t.getAttribute("id"),CursorPos=0;else{if(!(u=e.nextSibling)||IsMsupOrMrootSonNode(e)||IsCommaNode(u)){var i=t.getAttribute("id");IsNecesaryCreateSymbolicArgument(e)?(CreateSymbolicArgumentNode(e,"x"),CursorPos=0):(n=e.previousSibling)?(CursorPos=1,currId=n.getAttribute("id")):(CursorPos=0,currId=i)}else{var o=u.tagName,a="";(n=e.previousSibling)&&(a=n.tagName),"mn"!=a||"mn"!=o||IsImaginarySymbol(u)?(CursorPos=0,currId=u.getAttribute("id")):(n=JointMnNodes(n,u),currId=n.getAttribute("id"))}t.removeChild(e)}else if(IsGreyColorNode(e))IsFunctionArgumentNode(e)&&(t=t.parentNode),currId=t.getAttribute("id"),CursorPos=0;else{var s=e.childNodes[0].nodeValue;if(0==CursorPos)s=s.substr(1,s.length),CursorPos=e.previousSibling?1:0;else if(.5==CursorPos){var l=s.substring(0,NumDigitLeft),d=s.substring(NumDigitLeft+1,NumDigitLeft+NumDigitRight);if(NumDigitRight--,"e"==s.substring(NumDigitLeft,NumDigitLeft+1)&&(d="",NumDigitRight=0),s=l+d,0==NumDigitRight)if(e.nextSibling){var u=e.nextSibling;currId=u.getAttribute("id"),CursorPos=0}else CursorPos=1;else CursorPos=.5}if(0==s.length){u=e.nextSibling;if("mtd"==t.tagName)e.childNodes[0].nodeValue="0",CursorPos=0;else{if(u&&!IsCommaNode(u))currId=u.getAttribute("id"),CursorPos=0;else{i=t.getAttribute("id");IsNecesaryCreateSymbolicArgument(e)?(CreateSymbolicArgumentNode(e,"x"),CursorPos=0):(n=e.previousSibling,CursorPos=1,currId=n.getAttribute("id"))}t.removeChild(e)}}else e.childNodes[0].nodeValue=s}text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}}}}function Matrix(){if("root"!=currId){var e=GetElementById(expr_xml,currId);if(!e)return;if("mtd"==e.parentNode.tagName)return void alert("A matrix into other other matrix is not allowed!!!")}ActiveBody("#bodyMatrix")}function MatrixTypeFun(e){var r=document.getElementById("NumRows"),t=document.getElementById("NumCols");if("Rectangular"==e)$("#NumRowsP").show(),$("#NumColsP").show(),$("#AutoFillingP").show();else if("Square"==e){$("#NumRowsP").show();var n=r.value;$("#NumColsP").hide(),t.value=n,$("#AutoFillingP").show()}else if("Vector"==e)$("#NumRowsP").show(),$("#NumColsP").hide(),t.value=1,$("#AutoFillingP").show();else if("Row vector"==e)$("#NumRowsP").hide(),r.value=1,$("#NumColsP").show(),$("#AutoFillingP").show();else if("Identity matrix"==e){$("#NumRowsP").show();n=r.value;$("#NumColsP").hide(),t.value=n,$("#AutoFillingP").hide()}}function RowsChangeFun(e){var r=document.getElementById("matrix_type").value;"Identity matrix"!=r&&"Square"!=r||(document.getElementById("NumCols").value=e)}function AcceptMatrix(){isScreenMode||ClearAll(),isScreenMode=!0;var e=window.document.getElementById("NumRows").value,r=window.document.getElementById("NumCols").value,t=window.document.getElementById("matrix_type").value,n=window.document.getElementById("AutoFilling").value,i="A";1!=e&&1!=r||(i=i.toLowerCase()),matrix_list[++matrix_cont-1]=new Array(3),matrix_list[matrix_cont-1][0]=e,matrix_list[matrix_cont-1][1]=r,matrix_list[matrix_cont-1][2]=i;var o=!1;$("#bodyCalculator").show(),$("#bodyMatrix").hide();var a,s=null,l="";"root"!=currId?(a=(s=GetElementById(expr_xml,currId)).parentNode,(IsExponentOfPower(s)||IsIndexOfRoot(s))&&(o=!0),s=FindFirstCorrectNode(currId)):a=expr_xml.documentElement;var d=expr_xml.createElement("mfenced"),u=expr_xml.createAttribute("open");u.nodeValue="[",d.setAttributeNode(u);var m=expr_xml.createAttribute("close");m.nodeValue="]",d.setAttributeNode(m);var c,p=expr_xml.createAttribute("id"),f="mfenced_"+ ++mfenced_cont;if(p.nodeValue=f,d.setAttributeNode(p),matrix_list[matrix_cont-1][3]=f,s){if(0==CursorPos)c=a.insertBefore(d,s);else if(1==CursorPos){var x=s.nextSibling;c=x?a.insertBefore(d,x):a.appendChild(d)}else if(.5==CursorPos&&(l="mn")){var _=s.childNodes[0].nodeValue,v=_.substring(0,NumDigitLeft);ChangeTextToMnNode(s,_.substring(NumDigitLeft,NumDigitLeft+NumDigitRight));var N=CreateMnElement(v);a.insertBefore(N,s);c=a.insertBefore(d,s)}}else if(IsMsup(a)||IsMroot(a))if(o)c=a.appendChild(d);else{var b=a.lastChild;c=a.insertBefore(d,b)}else c=a.appendChild(d);"mn"==l&&(0==parseFloat(s.childNodes[0].nodeValue)&&(a.removeChild(s),l=""));var g=expr_xml.createElement("mtable"),h=expr_xml.createAttribute("id"),I="mtable_"+ ++mtable_cont;h.nodeValue=I,g.setAttributeNode(h);for(var C=c.appendChild(g),A=1;A<=e;A++)for(var y=expr_xml.createElement("mtr"),V=(expr_xml.createAttribute("id"),C.appendChild(y)),S=1;S<=r;S++){var D=expr_xml.createElement("mtd"),M=expr_xml.createAttribute("columnalign");M.nodeValue="right",D.setAttributeNode(M);var F=V.appendChild(D),P=expr_xml.createElement("mn"),E=expr_xml.createAttribute("id"),L="mn_"+ ++mn_cont;if(E.nodeValue=L,P.setAttributeNode(E),"None"==n&&"Identity matrix"!=t){var T=expr_xml.createAttribute("color");T.nodeValue="#A4A4A4",P.setAttributeNode(T);var w=F.appendChild(P),O=expr_xml.createTextNode(i),U=(w.appendChild(O),expr_xml.createElement("mn")),B=expr_xml.createAttribute("id"),G="mn_"+ ++mn_cont;B.nodeValue=G,U.setAttributeNode(B);var R=expr_xml.createAttribute("color");R.nodeValue="#A4A4A4",U.setAttributeNode(R);var k=expr_xml.createAttribute("mathsize");k.nodeValue="0.7",U.setAttributeNode(k);var z,H=F.appendChild(U);z=1==r&&e>1?A:r>1&&1==e?S:A+","+S;var q=expr_xml.createTextNode(z);H.appendChild(q);1==A&&1==S&&(currId=G,CursorPos=1)}else{var J;w=F.appendChild(P);"Identity matrix"==t?J=A==S?"1":"0":"Zero filling"==n?J="0":"Ones filling"==n?J="1":"Consecutive filling"==n&&(J=((A-1)*r+S).toString());O=expr_xml.createTextNode(J),w.appendChild(O);1==A&&1==S&&(currId=L,CursorPos=1)}}Matrix_cont++,text_screen=xml_Serial.serializeToString(expr_xml),DefineRowsHeight(),InputChanges()}function CancelMatrix(){isScreenMode||ClearAll(),isScreenMode=!0,$("#bodyCalculator").show(),$("#bodyMatrix").hide(),DefineRowsHeight(),Preview.UpdateCursorPosition()}function IsVisibleNode(e){if(!e)return!1;var r=!0,t=e.tagName;return"mfrac"!=t&&"msup"!=t&&"msqrt"!=t&&"mroot"!=t||(r=!1),"mfenced"==t&&""==e.getAttribute("open")&&""==e.getAttribute("close")&&(r=!1),r}function IsMfrac(e){if(!e)return!1;var r=!1;return"mfrac"==e.tagName&&(r=!0),r}function IsNumeratorOfMfrac(e){if(!e)return!1;var r=!1,t=e.parentNode.parentNode;IsMfrac(t)&&(e==t.firstChild.firstChild&&(r=!0));return r}function IsNumOrDenOfMfrac(e){if(!e)return!1;var r=!1;return IsMfrac(e.parentNode)&&(r=!0),r}function IsMsqrt(e){if(!e)return!1;var r=!1;return"msqrt"==e.tagName&&(r=!0),r}function IsMroot(e){if(!e)return!1;var r=!1;return"mroot"==e.tagName&&(r=!0),r}function IsMsup(e){if(!e)return!1;var r=!1;return"msup"==e.tagName&&(r=!0),r}function IsMsupOrMrootSonNode(e){if(!e)return!1;is_MsupOrMrootSonNode=!1;var r=e.parentNode;return(IsMroot(r)||IsMsup(r))&&(is_MsupOrMrootSonNode=!0),is_MsupOrMrootSonNode}function IsMsupOrMrootOrMsqrtSonNode(e){if(!e)return!1;is_MsupOrMrootOrMsqrtSonNode=!1;var r=e.parentNode;return(IsMroot(r)||IsMsup(r)||IsMsqrt(r))&&(is_MsupOrMrootOrMsqrtSonNode=!0),is_MsupOrMrootOrMsqrtSonNode}function IsEditableNode(e){if(!e)return!1;var r=e.tagName;return is_editable=!0,"mi"==r&&(is_editable=!1),is_editable}function IsMiLibFunNode(e){if(!e)return!1;var r=!1;return"mi"!=e.tagName?r=!1:(MiType=e.getAttribute("type"),"lib"==MiType&&(r=!0)),r}function IsGreyColorNode(e){if(!e)return!1;var r=!1;return"#A4A4A4"==e.getAttribute("color")&&(r=!0),r}function IsThereGreyColorNodes(e){for(var r=!1,t=e.childNodes,n=0;n<t.length;n++)if("#A4A4A4"==t[n].getAttribute("color")){r=!0;break}return r}function IsEexPreviousNode(e){if(!e)return!1;var r=!1,t=e.previousSibling;t&&("mn"==t.tagName&&0!=searchCharacter(t.childNodes[0].nodeValue,"e")&&(r=!0));return r}function IsTextNodeChild(e){if(!e)return!1;var r=!1;return"#text"==e.lastChild.nodeName&&(r=!0),r}function IsVisibleParenthesisNode(e){if(!e)return!1;var r=!1;return"mfenced"==e.tagName&&""!=e.getAttribute("open")&&""!=e.getAttribute("close")&&(r=!0),r}function IsNonVisibleParenthesisNode(e){if(!e)return!1;var r=!1;return"mfenced"==e.tagName&&""==e.getAttribute("open")&&""==e.getAttribute("close")&&(r=!0),r}function IsNonErasebleNode(e){if(!e)return!1;var r=!1;return"non_erasable"==e.getAttribute("type")&&(r=!0),r}function IsNodeWithId(e){if(!e)return!1;node_id=e.getAttribute("id");var r=!0;return node_id||(r=!1),r}function IsParenthesisNode(e){if(!e)return!1;var r=!1;if("mfenced"==e.tagName){e.firstChild;r=!0}return r}function IsTableNode(e){if(!e)return!1;var r=!1,t=e.tagName;return"mtr"!=t&&"mtd"!=t&&"mtable"!=t||(r=!0),r}function InteriorNodeTagName(e){if(!e)return!1;var r="";IsTextNodeChild(e)||IsNonVisibleParenthesisNode(e)&&(r=e.lastChild.tagName);return r}function IsMsupGrandSonNode(e){if(!e)return!1;var r=!1;return"msup"==e.parentNode.parentNode.tagName&&(r=!0),r}function IsInverseOrTransposeGrandSonNode(e){if(!e)return!1;var r=!1,t=e.parentNode.parentNode;if("msup"==t.tagName){var n=t.lastChild.childNodes[0].nodeValue;"T"!=n&&"-1"!=n||(r=!0)}return r}function IsTwoArgumentsFunction(e){if(!e)return!1;var r=e.previousSibling,t=!1;return r&&"mi"==r.tagName&&","==r.childNodes[0].nodeValue&&(t=!0),t}function IsFunctionArgumentNode(e){if(!e)return!1;var r=!1,t=e.parentNode.parentNode.firstChild;return(IsMiLibFunNode(t)||IsUDFMiNode(t))&&(r=!0),r}function IsFunctionParenthesisNode(e){if(!e)return!1;var r=!1;if("mfenced"==e.tagName){var t=e.previousSibling;t&&"mi"==t.tagName&&IsMiLibFunNode(t)&&(r=!0)}return r}function IsCommaNode(e){if(!e)return!1;var r=!1;return e&&"mi"==e.tagName&&","==e.childNodes[0].nodeValue&&(r=!0),r}function IsExponentOfPower(e){if(!e)return!1;var r=!1,t=e.parentNode;if("msup"==t.tagName){var n=t.lastChild;n.getAttribute("id")&&e==n&&(r=!0)}return r}function IsIndexOfRoot(e){if(!e)return!1;var r=!1,t=e.parentNode;if("mroot"==t.tagName){var n=t.lastChild;n.getAttribute("id")&&e==n&&(r=!0)}return r}function IsLinSolveArgument(e){if(!e)return!1;var r=!1,t=e.parentNode.parentNode.firstChild;return"mi"==t.tagName&&"LinSolve"==t.childNodes[0].nodeValue&&(r=!0),r}function IsArgumentOfFunction(e){if(!e)return!1;var r=!1;return"mi"==e.parentNode.parentNode.firstChild.tagName&&(r=!0),r}function IsDetArgument(e){if(!e)return!1;var r=!1,t=e.parentNode.parentNode.firstChild;return"mi"==t.tagName&&"det"==t.childNodes[0].nodeValue&&(r=!0),r}function IsEigvArgument(e){if(!e)return!1;var r=!1,t=e.parentNode.parentNode.firstChild;return"mi"==t.tagName&&"Eigv"==t.childNodes[0].nodeValue&&(r=!0),r}function IsNecesaryCreateSymbolicArgument(e){if(!e)return!1;var r=!1,t=e.parentNode;return"root"!=t.getAttribute("id")&&(1==t.childNodes.length&&(r=!0),"msup"==t.tagName&&(r=!0),"mroot"==t.tagName&&(r=!0),IsLinSolveArgument(e)&&(r=!0),IsParamOfUDF(e)&&(r=!0)),r}function IsParamOfUDF(e){if(!e)return!1;var r=!1,t=e.parentNode.previousSibling;return t&&IsUDFMiNode(t)&&(r=!0),r}function GiveParamName(e){var r={Name:"x",Type:"number"},t=e.parentNode,n=t.previousSibling;if(IsUDFMiNode(n)){for(var i,o=n.childNodes[0].nodeValue,a=userDefFunLabel_list.indexOf(o),s=t.childNodes,l=0;l<s.length;l++)if(s[l]===e){i=l/2;break}r.Name=userDefFunParamNames[a][i],r.Type=userDefFunParamType_list[a][i]}return r}function FindPreviousNode(e,r){if(e){var t=e;if(0==r){IsTableNode(t.parentNode)&&((t=t.parentNode).previousSibling?(t=(t=t.previousSibling).lastChild,CursorPos=1):(t=t.parentNode).previousSibling?(t=(t=(t=t.previousSibling).lastChild).lastChild,CursorPos=1):t=t.parentNode);var n=!1;if(IsVisibleParenthesisNode(t.parentNode))if(IsTwoArgumentsFunction(t))t=t.previousSibling.previousSibling,CursorPos=1;else if(IsMsupGrandSonNode(t=t.parentNode)&&(t=t.parentNode.parentNode),t.previousSibling)if(IsEditableNode(t=t.previousSibling)){if(IsNonVisibleParenthesisNode(t))for(t=t.lastChild;IsNonVisibleParenthesisNode(t)&&!IsTextNodeChild(t);)t=t.lastChild;CursorPos=1}else IsNonVisibleParenthesisNode(t.parentNode)&&(t=t.parentNode),t.previousSibling&&!IsNonErasebleNode(t.previousSibling)?(t=t.previousSibling,CursorPos=1):CursorPos=0;else CursorPos=0,n=!0;else if(IsNonVisibleParenthesisNode(t.parentNode)&&IsNonVisibleParenthesisNode(t=t.parentNode))for(var i=!0;i;)t.previousSibling?(IsTextNodeChild(t=t.previousSibling)||(t=t.lastChild),i=!1,CursorPos=1):"root"!=t.parentNode.getAttribute("id")?IsNonVisibleParenthesisNode(t=t.parentNode)||IsMfrac(t)||IsMsup(t)||(n=!0,i=!1):(i=!1,CursorPos=0);!n&&(IsMsqrt(t.parentNode)||IsMsup(t.parentNode)||IsMroot(t.parentNode))&&(IsExponentOfPower(t)||IsIndexOfRoot(t)?(t=t.previousSibling)?CursorPos=1:(t=(t=e.parentNode).previousSibling)?CursorPos=1:(t=e.parentNode.parentNode,CursorPos=0):(t=t.parentNode).previousSibling?(t=t.previousSibling,CursorPos=1):CursorPos=0)}else if(1==r){if(!t.hasChildNodes()||IsTextNodeChild(t)||IsNonErasebleNode(t))if(!(t=t.previousSibling)||IsNonErasebleNode(t))CursorPos=IsNonErasebleNode(t=e)?1:0;else{var o=t.nextSibling;IsCommaNode(t)||IsExponentOfPower(o)||IsIndexOfRoot(o)?(t=e,CursorPos=0):CursorPos=1}else if(IsVisibleNode(t)){for(IsParenthesisNode(t)&&(t=t.lastChild);IsTableNode(t);)t=t.lastChild;CursorPos=1}else if(IsMfrac(t)){for(;!IsVisibleNode(t)&&!IsTextNodeChild(t);)t=t.lastChild;CursorPos=1}else if(IsMsqrt(t))t=t.lastChild,CursorPos=1;else if(IsMsup(t)||IsMroot(t))(t=t.lastChild).getAttribute("id")?CursorPos=1:(IsTextNodeChild(t=t.previousSibling)||(t=t.lastChild),CursorPos=1);else{for(;IsNonVisibleParenthesisNode(t)&&!IsTextNodeChild(t);)t=t.lastChild;IsVisibleParenthesisNode(t)?(t=t.lastChild,CursorPos=1):t.previousSibling||(CursorPos=0)}}return t}}function LeftArrow(){if(isScreenMode=!0,currId&&"root"!=currId){var e,r=GetElementById(expr_xml,currId);if(r.parentNode,"mn"==r.tagName)if("mn"==InteriorNodeTagName(r)&&(r=r.lastChild),NumText=r.childNodes[0].nodeValue,NumText.length>1){if(e=r,isDecimalPoint=searchCharacter(NumText,"."),1==CursorPos){NumDigitLeft=NumText.length-1,NumDigitRight=1,CursorPos=.5;var t=r.getAttribute("color"),n=CursorPos;"#A4A4A4"==t&&(e=FindPreviousNode(r,n=0))}else if(.5==CursorPos)NumDigitRight++,0==--NumDigitLeft&&(e=FindPreviousNode(r,CursorPos=1));else if(0==CursorPos){e=FindPreviousNode(r,n=CursorPos)}}else{t=r.getAttribute("color"),n=CursorPos;"#A4A4A4"==t?n=0:(NumDigitLeft=0,NumDigitRight=1),e=FindPreviousNode(r,n)}else e=FindPreviousNode(r,CursorPos);currId=e.getAttribute("id"),text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}}function RightArrow(){if(isScreenMode=!0,currId&&"root"!=currId){var e,r,t=GetElementById(expr_xml,currId);e=t.parentNode;var n=t.tagName;if("mn"==n)if(NumText=t.childNodes[0].nodeValue,NumText.length>1){if(r=t,isDecimalPoint=searchCharacter(NumText,"."),1==CursorPos)r=FindNextNode(t,CursorPos);else if(.5==CursorPos)NumDigitLeft++,0==--NumDigitRight&&(r=t,CursorPos=1);else if(0==CursorPos){NumDigitLeft=1,NumDigitRight=NumText.length-1,CursorPos=.5;var i=t.getAttribute("color");"#A4A4A4"==i&&(r=FindNextNode(t,0))}}else{i=t.getAttribute("color");"#A4A4A4"==i?r=FindNextNode(t,1):0==CursorPos?(r=t,CursorPos=1):r=FindNextNode(t,1)}else if("mo"==n){var o="";(r=t.nextSibling)&&(o=r.tagName),"mn"==o?(NumText=r.childNodes[0].nodeValue,NumText.length>1?(isDecimalPoint=searchCharacter(NumText,"."),NumDigitLeft=1,NumDigitRight=NumText.length-1,CursorPos=.5):CursorPos=1):0==CursorPos?(r=t,CursorPos=1):r=FindNextNode(t,1)}else(r=FindNextNode(t,CursorPos))==t&&(0==CursorPos?CursorPos=1:"root"!=e.getAttribute("id")&&(r=e));currId=r.getAttribute("id"),text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}}function FindNextNode(e,r){if(e){var t=e;if(0==r){if(t.hasChildNodes()&&!IsTextNodeChild(t))if(IsVisibleNode(t)){for(IsParenthesisNode(t)&&(t=t.firstChild);IsTableNode(t);)t=t.firstChild;IsGreyColorNode(t)?(t.nextSibling&&(t=t.nextSibling),CursorPos=1):CursorPos=0}else if(IsMfrac(t)){for(;!IsVisibleNode(t)&&!IsTextNodeChild(t);)t=t.firstChild;CursorPos=0}else if(IsMsqrt(t))t=t.firstChild,CursorPos=IsGreyColorNode(t)?1:0;else if(IsMsup(t)||IsMroot(t))IsNonVisibleParenthesisNode(t=t.firstChild)&&(t=t.firstChild),t.getAttribute("id")?CursorPos=IsGreyColorNode(t)?1:0:(IsTextNodeChild(t=t.nextSibling)||(t=t.firstChild),t=1);else{for(;IsNonVisibleParenthesisNode(t)&&!IsTextNodeChild(t);)t=t.firstChild;IsMiLibFunNode(t)||IsUDFMiNode(t)?(t=(t=t.nextSibling).firstChild,CursorPos=IsGreyColorNode(t)?1:0):CursorPos=1}}else 1==r&&(t.nextSibling&&(IsNodeWithId(t.nextSibling)||IsCommaNode(t.nextSibling))?IsCommaNode(t=t.nextSibling)?(t=t.nextSibling,IsGreyColorNode(t)?(t.nextSibling&&!IsCommaNode(t.nextSibling)&&(t=t.nextSibling),CursorPos=1):CursorPos=1):IsParenthesisNode(t)||IsMfrac(t)?(IsMiLibFunNode(t=t.firstChild)||IsUDFMiNode(t)?t=(t=t.nextSibling).firstChild:IsNonVisibleParenthesisNode(t)&&(t=t.firstChild),CursorPos=IsGreyColorNode(t)?1:0):IsMsqrt(t)||IsMsup(t)||IsMroot(t)?(t=t.firstChild,CursorPos=IsGreyColorNode(t)?1:0):CursorPos=1:IsTableNode(t.parentNode)?((t=t.parentNode).nextSibling?(t=(t=t.nextSibling).firstChild,IsGreyColorNode(t)?(t.nextSibling&&(t=t.nextSibling),CursorPos=1):CursorPos=1):(t=t.parentNode).nextSibling?(t=(t=(t=t.nextSibling).firstChild).firstChild,IsGreyColorNode(t)?(t.nextSibling&&(t=t.nextSibling),CursorPos=1):CursorPos=1):t=t.parentNode,IsVisibleParenthesisNode(t.parentNode)&&(t=t.parentNode,CursorPos=1)):IsArgumentOfFunction(t)?(IsNonVisibleParenthesisNode((t=t.parentNode).parentNode)&&(t=t.parentNode),CursorPos=1):IsVisibleParenthesisNode(t.parentNode)?(t=t.parentNode,CursorPos=1):IsMsqrt(t.parentNode)||IsMsup(t.parentNode)||IsMroot(t.parentNode)?(t=t.parentNode,CursorPos=1):IsInverseOrTransposeGrandSonNode(t)?(t=t.parentNode.parentNode,CursorPos=1):IsMfrac(t.parentNode.parentNode)&&(IsNumeratorOfMfrac(t)?(t=(t=(t=t.parentNode).nextSibling).firstChild,CursorPos=IsGreyColorNode(t)?1:0):(t=t.parentNode.parentNode,CursorPos=1)));return t}}function Pow(){0==Shift_state?SquarePow():GenericPow()}function IsMnZeroValueNode(e){if(isMnZeroValueNode=!1,!e)return!1;(currTag=e.tagName,"mn"==currTag)&&("0"==e.firstChild.nodeValue&&(isMnZeroValueNode=!0));return isMnZeroValueNode}function SquarePow(){isScreenMode||ClearAll(),isScreenMode=!0;var e,r=null;"root"!=currId?(e=(r=GetElementById(expr_xml,currId)).parentNode,("mn"==r.tagName&&!IsGreyColorNode(r)||IsParamMiNode(r)||IsVarMiNode(r))&&(IsMnZeroValueNode(r)||inputOperator("×"))):e=expr_xml.documentElement;var t,n,i=expr_xml.createElement("msup"),o=expr_xml.createAttribute("id"),a="msup_"+ ++msup_cont;if(o.nodeValue=a,i.setAttributeNode(o),r&&IsGreyColorNode(r))n=InsertMnNode(t=e.insertBefore(i,r),"number","x"),IsLinSolveArgument(r)||IsArgumentOfFunction(r)?e.removeChild(r):IsThereGreyColorNodes(e)&&RemoveGreyNodes(e);else if(n=InsertMnNode(t=e.appendChild(i),"number","x"),t.previousSibling){var s=t.previousSibling;if("mn"==s.tagName)"0"==s.firstChild.nodeValue&&e.removeChild(s)}currId=n.getAttribute("id"),CursorPos=1;var l=expr_xml.createElement("mn"),d=t.appendChild(l),u=expr_xml.createTextNode("2");d.appendChild(u);text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}function InsertMnNode(e,r,t){var n=expr_xml.createElement("mn"),i=expr_xml.createAttribute("id"),o="mn_"+ ++mn_cont;currId=o,i.nodeValue=o,n.setAttributeNode(i);var a=expr_xml.createAttribute("color");if(a.nodeValue="#A4A4A4",n.setAttributeNode(a),"matrix"==r)(s=expr_xml.createAttribute("mathvariant")).nodeValue="bold",n.setAttributeNode(s);else if("number"==r){var s;(s=expr_xml.createAttribute("mathvariant")).nodeValue="italic",n.setAttributeNode(s)}var l=e.appendChild(n),d=expr_xml.createTextNode(t);return l.appendChild(d),l}function InsertMnNode_alt(e,r,t,n){var i=expr_xml.createElement("mn"),o=expr_xml.createAttribute("id"),a="mn_"+ ++mn_cont;currId=a,o.nodeValue=a,i.setAttributeNode(o);var s,l=expr_xml.createAttribute("color");if(l.nodeValue="#A4A4A4",i.setAttributeNode(l),"matrix"==t)(d=expr_xml.createAttribute("mathvariant")).nodeValue="bold",i.setAttributeNode(d);else if("number"==t){var d;(d=expr_xml.createAttribute("mathvariant")).nodeValue="italic",i.setAttributeNode(d)}if(0==CursorPos)s=r.insertBefore(i,e);else{var u=e.nextSibling;s=u?r.insertBefore(i,u):r.appendChild(i)}var m=expr_xml.createTextNode(n);return s.appendChild(m),s}function GenericPow(){isScreenMode||ClearAll(),isScreenMode=!0;var e,r=null;"root"!=currId?(e=(r=GetElementById(expr_xml,currId)).parentNode,"mn"!=r.tagName||IsGreyColorNode(r)||IsMnZeroValueNode(r)||inputOperator("×")):e=expr_xml.documentElement;var t,n,i=expr_xml.createElement("msup"),o=expr_xml.createAttribute("id"),a="msup_"+ ++msup_cont;if(o.nodeValue=a,i.setAttributeNode(o),r&&IsGreyColorNode(r))n=InsertMnNode(t=e.insertBefore(i,r),"number","x"),IsLinSolveArgument(r)||IsArgumentOfFunction(r)?e.removeChild(r):IsThereGreyColorNodes(e)&&RemoveGreyNodes(e);else if(n=InsertMnNode(t=e.appendChild(i),"number","x"),t.previousSibling){var s=t.previousSibling;if("mn"==s.tagName)"0"==s.firstChild.nodeValue&&e.removeChild(s)}currId=n.getAttribute("id"),CursorPos=1;var l=expr_xml.createElement("mn"),d=expr_xml.createAttribute("id"),u="mn_"+ ++mn_cont;d.nodeValue=u,l.setAttributeNode(d);var m=expr_xml.createAttribute("color");m.nodeValue="#A4A4A4",l.setAttributeNode(m);var c=expr_xml.createAttribute("mathvariant");c.nodeValue="italic",l.setAttributeNode(c);var p=t.appendChild(l),f=expr_xml.createTextNode("y");p.appendChild(f);text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}function Root(){0==Shift_state?SquareRoot():GenericRoot()}function SquareRoot(){isScreenMode||ClearAll(),isScreenMode=!0;var e,r=null;e="root"!=currId?(r=GetElementById(expr_xml,currId)).parentNode:expr_xml.documentElement;var t,n,i=expr_xml.createElement("msqrt"),o=expr_xml.createAttribute("id"),a="msqrt_"+ ++msqrt_cont;if(o.nodeValue=a,i.setAttributeNode(o),r&&IsGreyColorNode(r))n=InsertMnNode(t=e.insertBefore(i,r),"number","x"),IsLinSolveArgument(r)||IsArgumentOfFunction(r)?e.removeChild(r):IsThereGreyColorNodes(e)&&RemoveGreyNodes(e);else if(n=InsertMnNode(t=e.appendChild(i),"number","x"),t.previousSibling){var s=t.previousSibling;if("mn"==s.tagName)"0"==s.firstChild.nodeValue&&e.removeChild(s)}currId=n.getAttribute("id"),CursorPos=1,text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}function GenericRoot(){isScreenMode||ClearAll(),isScreenMode=!0;var e,r=null;e="root"!=currId?(r=GetElementById(expr_xml,currId)).parentNode:expr_xml.documentElement;var t,n,i=expr_xml.createElement("mroot"),o=expr_xml.createAttribute("id"),a="mroot_"+ ++mroot_cont;if(o.nodeValue=a,i.setAttributeNode(o),r&&IsGreyColorNode(r))t=e.insertBefore(i,r),n=InsertMnNode(i,"number","x"),IsLinSolveArgument(r)||IsArgumentOfFunction(r)?e.removeChild(r):IsThereGreyColorNodes(e)&&RemoveGreyNodes(e);else if(n=InsertMnNode(t=e.appendChild(i),"number","x"),t.previousSibling){var s=t.previousSibling;if("mn"==s.tagName)"0"==s.firstChild.nodeValue&&e.removeChild(s)}currId=n.getAttribute("id"),CursorPos=1;var l=expr_xml.createElement("mn"),d=expr_xml.createAttribute("id"),u="mn_"+ ++mn_cont;d.nodeValue=u,l.setAttributeNode(d);var m=expr_xml.createAttribute("color");m.nodeValue="#A4A4A4",l.setAttributeNode(m);var c=expr_xml.createAttribute("mathvariant");c.nodeValue="italic",l.setAttributeNode(c);var p=t.appendChild(l),f=expr_xml.createTextNode("y");p.appendChild(f);text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}function Parenthesis(){isScreenMode||ClearAll(),isScreenMode=!0;var e,r,t=null,n=!1;if("root"!=currId){if(!(t=GetElementById(expr_xml,currId)))return;(IsExponentOfPower(t)||IsIndexOfRoot(t))&&(n=!0),r=t.parentNode,e=t.tagName,IsGreyColorNode(t)&&(e=(t=FindFirstCorrectNode(currId))?t.tagName:"")}else e="",r=expr_xml.documentElement;"mn"==e&&(0==parseFloat(t.childNodes[0].nodeValue)&&(r.removeChild(t),e=""));var i=expr_xml.createElement("mfenced");mfenced_cont++;var o=expr_xml.createAttribute("open");o.nodeValue="(",i.setAttributeNode(o);var a=expr_xml.createAttribute("close");a.nodeValue=")",i.setAttributeNode(a);var s=expr_xml.createAttribute("id"),l="mfenced_"+mfenced_cont;s.nodeValue=l,i.setAttributeNode(s);var d,u=expr_xml.createAttribute("separators");if(u.nodeValue="",i.setAttributeNode(u),t)if(0==CursorPos)d=r.insertBefore(i,t);else{var m=t.nextSibling;d=m?r.insertBefore(i,m):r.appendChild(i)}else if(IsMsup(r)||IsMroot(r))if(n)d=r.appendChild(i);else{var c=r.lastChild;d=r.insertBefore(i,c)}else d=r.appendChild(i);var p=expr_xml.createElement("mn"),f=expr_xml.createAttribute("id"),x="mn_"+ ++mn_cont;currId=x,f.nodeValue=x,p.setAttributeNode(f);var _=expr_xml.createAttribute("color");_.nodeValue="#A4A4A4",p.setAttributeNode(_);var v=expr_xml.createAttribute("mathvariant");v.nodeValue="italic",p.setAttributeNode(v);var N=d.appendChild(p),b=expr_xml.createTextNode("x");N.appendChild(b);CursorPos=1,parenthesis_cont++,text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}function Transpose_and_Inverse(e){isScreenMode||ClearAll(),isScreenMode=!0;var r,t,n=null;"root"!=currId?(t=(n=GetElementById(expr_xml,currId)).parentNode,r=n.tagName):(t=expr_xml.documentElement,r="");var i,o,a=expr_xml.createElement("msup"),s=expr_xml.createAttribute("id"),l="msup_"+ ++msup_cont;s.nodeValue=l,a.setAttributeNode(s);var d=!1;n&&"mo"!=r&&!IsNonErasebleNode(n)||IsGreyColorNode(n)?(o=(i=t.insertBefore(a,n)).appendChild(n),d=!0):o=InsertMnNode(i=t.appendChild(a),"matrix","A");var u=expr_xml.createElement("mfenced");mfenced_cont++;var m=expr_xml.createAttribute("open");m.nodeValue="",u.setAttributeNode(m);var c=expr_xml.createAttribute("close");c.nodeValue="",u.setAttributeNode(c);var p=expr_xml.createAttribute("id"),f="mfenced_"+ ++mfenced_cont;p.nodeValue=f,u.setAttributeNode(p);var x=expr_xml.createAttribute("separators");x.nodeValue="",u.setAttributeNode(x);i.appendChild(u).appendChild(o);var _=expr_xml.createElement("mi"),v=i.appendChild(_);if("Transpose"==e)N=expr_xml.createTextNode("T");else if("Inverse"==e)var N=expr_xml.createTextNode("-1");v.appendChild(N);var b=expr_xml.createAttribute("type");b.nodeValue="lib",_.setAttributeNode(b),currId=d?l:o.getAttribute("id"),CursorPos=1,text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}function TrigFunctions(e){if(0==Shift_state)switch(e){case"sin":GenericFunction("sin");break;case"cos":GenericFunction("cos");break;case"tan":GenericFunction("tan")}else if(1==Shift_state)switch(e){case"sin":GenericFunction("asin");break;case"cos":GenericFunction("acos");break;case"tan":GenericFunction("atan")}}function Pi_and_I(){0==Shift_state?inputNumber("π"):1==Shift_state&&inputNumber("i")}function GenericFunction(e){if(1==eigv_cont&&alert("Only one eigenvalues analysis by expression is allowed!!!"),"Eigv"!=e||!IsVar_DefinitionActive()&&!IsUDF_DefinitionActive()){var r,t,n;isScreenMode&&"Eigv"!=e||ClearAll(),isScreenMode=!0;var i=!1;if("root"!=currId){if(!(r=GetElementById(expr_xml,currId)))return;(IsExponentOfPower(r)||IsIndexOfRoot(r))&&(i=!0),n=r.parentNode,t=r.tagName,IsGreyColorNode(r)&&(t=(r=FindFirstCorrectNode(currId))?r.tagName:"")}else t="",n=expr_xml.documentElement;if("mn"==t)0==parseFloat(r.childNodes[0].nodeValue)&&(n.removeChild(r),t="");"normalize"==e&&normalize_cont++;var o=expr_xml.createElement("mfenced");mfenced_cont++;var a=expr_xml.createAttribute("open");a.nodeValue="",o.setAttributeNode(a);var s=expr_xml.createAttribute("close");s.nodeValue="",o.setAttributeNode(s);var l=expr_xml.createAttribute("id"),d="mfenced_"+mfenced_cont;l.nodeValue=d,o.setAttributeNode(l);var u,m=expr_xml.createAttribute("separators");if(m.nodeValue="",o.setAttributeNode(m),r){if(0==CursorPos)u=n.insertBefore(o,r);else if(1==CursorPos){var c=r.nextSibling;u=c?n.insertBefore(o,c):n.appendChild(o)}else if(.5==CursorPos&&(t="mn")){var p=r.childNodes[0].nodeValue,f=p.substring(0,NumDigitLeft);ChangeTextToMnNode(r,p.substring(NumDigitLeft,NumDigitLeft+NumDigitRight));var x=CreateMnElement(f);n.insertBefore(x,r);u=n.insertBefore(o,r)}}else if(IsMsup(n)||IsMroot(n))if(i)u=n.appendChild(o);else{var _=n.lastChild;u=n.insertBefore(o,_)}else u=n.appendChild(o);var v=expr_xml.createElement("mi"),N=expr_xml.createAttribute("id"),b="mi_"+ ++mi_cont;N.nodeValue=b,v.setAttributeNode(N);var g=expr_xml.createAttribute("type");g.nodeValue="lib",v.setAttributeNode(g);var h=u.appendChild(v),I=expr_xml.createTextNode(e),C=(h.appendChild(I),expr_xml.createElement("mfenced"));mfenced_cont++;var A=expr_xml.createAttribute("open");A.nodeValue="(",C.setAttributeNode(A);var y=expr_xml.createAttribute("close");y.nodeValue=")",C.setAttributeNode(y);var V=expr_xml.createAttribute("id"),S="mfenced_"+mfenced_cont;V.nodeValue=S,C.setAttributeNode(V);var D=expr_xml.createAttribute("separators");D.nodeValue="",C.setAttributeNode(D);var M=u.appendChild(C),F=expr_xml.createElement("mn"),P=expr_xml.createAttribute("id"),E="mn_"+ ++mn_cont;currId=E,P.nodeValue=E,F.setAttributeNode(P);var L=expr_xml.createAttribute("color");L.nodeValue="#A4A4A4",F.setAttributeNode(L);var T,w=M.appendChild(F),O="x";if("det"==e||"trace"==e||"Eigv"==e)O="A",(T=expr_xml.createAttribute("mathvariant")).nodeValue="bold",F.setAttributeNode(T),"Eigv"==e&&eigv_cont++;else(T=expr_xml.createAttribute("mathvariant")).nodeValue="italic",F.setAttributeNode(T);var U=expr_xml.createTextNode(O);w.appendChild(U);CursorPos=1,function_cont++,text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}}function LinSolver(){var e,r,t;if(isScreenMode||ClearAll(),isScreenMode=!0,"root"!=currId){if(!(e=GetElementById(expr_xml,currId)))return;t=e.parentNode,r=e.tagName,IsGreyColorNode(e)&&(r=(e=FindFirstCorrectNode(currId))?e.tagName:"")}else r="",t=expr_xml.documentElement;"mn"==r&&(0==parseFloat(e.childNodes[0].nodeValue)&&(t.removeChild(e),r=""));var n=expr_xml.createElement("mfenced");mfenced_cont++;var i=expr_xml.createAttribute("open");i.nodeValue="",n.setAttributeNode(i);var o=expr_xml.createAttribute("close");o.nodeValue="",n.setAttributeNode(o);var a=expr_xml.createAttribute("id"),s="mfenced_"+mfenced_cont;a.nodeValue=s,n.setAttributeNode(a);var l,d=expr_xml.createAttribute("separators");if(d.nodeValue="",n.setAttributeNode(d),e)if(0==CursorPos)l=t.insertBefore(n,e);else{var u=e.nextSibling;l=u?t.insertBefore(n,u):t.appendChild(n)}else l=t.appendChild(n);var m=expr_xml.createElement("mi"),c=expr_xml.createAttribute("id"),p="mi_"+ ++mi_cont;c.nodeValue=p,m.setAttributeNode(c);var f=expr_xml.createAttribute("type");f.nodeValue="lib",m.setAttributeNode(f);var x=l.appendChild(m),_=expr_xml.createTextNode("LinSolve"),v=(x.appendChild(_),expr_xml.createElement("mfenced"));mfenced_cont++;var N=expr_xml.createAttribute("open");N.nodeValue="(",v.setAttributeNode(N);var b=expr_xml.createAttribute("close");b.nodeValue=")",v.setAttributeNode(b);var g=expr_xml.createAttribute("id"),h="mfenced_"+mfenced_cont;g.nodeValue=h,v.setAttributeNode(g);var I=expr_xml.createAttribute("separators");I.nodeValue="",v.setAttributeNode(I);var C=l.appendChild(v),A=expr_xml.createElement("mn"),y=expr_xml.createAttribute("id"),V="mn_"+ ++mn_cont;currId=V,y.nodeValue=V,A.setAttributeNode(y),(w=expr_xml.createAttribute("color")).nodeValue="#A4A4A4",A.setAttributeNode(w);var S=C.appendChild(A),D="A",M=expr_xml.createAttribute("mathvariant");M.nodeValue="bold",A.setAttributeNode(M);var F=expr_xml.createTextNode(D),P=(S.appendChild(F),expr_xml.createElement("mi")),E=C.appendChild(P),L=expr_xml.createTextNode(","),T=(E.appendChild(L),expr_xml.createAttribute("type"));T.nodeValue="coma",P.setAttributeNode(T);E=C.appendChild(P);var w,O=expr_xml.createElement("mn"),U=expr_xml.createAttribute("id"),$="mn_"+ ++mn_cont;U.nodeValue=$,O.setAttributeNode(U),(w=expr_xml.createAttribute("color")).nodeValue="#A4A4A4",O.setAttributeNode(w);var B=C.appendChild(O),G=(D="b",expr_xml.createAttribute("mathvariant"));G.nodeValue="bold",O.setAttributeNode(G);var R=expr_xml.createTextNode(D);B.appendChild(R);linsolve_cont++,CursorPos=1,text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}function Fraction(){var e,r,t;isScreenMode||ClearAll(),isScreenMode=!0;var n="x",i="";if("root"!=currId){if(!(e=GetElementById(expr_xml,currId)))return;r=e.tagName,t=e.parentNode,"mo"==r||IsNonErasebleNode(e)?(i=(e=InsertMnNode_alt(e,t,"number","x")).getAttribute("id"),n="y"):IsGreyColorNode(e)&&(i=e.getAttribute("id"),n="y")}else i=(e=InsertMnNode(t=expr_xml.documentElement,"number","x")).getAttribute("id"),n="y";var o=expr_xml.createElement("mfrac"),a=expr_xml.createAttribute("id"),s="mfrac_"+ ++mfrac_cont;a.nodeValue=s,o.setAttributeNode(a);var l=e.nextSibling;nodeMfrac=l?t.insertBefore(o,l):t.appendChild(o),t.removeChild(e);var d=expr_xml.createElement("mfenced");mfenced_cont++,(f=expr_xml.createAttribute("open")).nodeValue="",d.setAttributeNode(f);var u=expr_xml.createAttribute("close");u.nodeValue="",d.setAttributeNode(u);var m=expr_xml.createAttribute("id"),c="mfenced_"+ ++mfenced_cont;m.nodeValue=c,d.setAttributeNode(m);var p=expr_xml.createAttribute("separators");p.nodeValue="",d.setAttributeNode(p);nodeMfrac.appendChild(d).appendChild(e);var f,x=expr_xml.createElement("mfenced");mfenced_cont++,(f=expr_xml.createAttribute("open")).nodeValue="",x.setAttributeNode(f);var _=expr_xml.createAttribute("close");_.nodeValue="",x.setAttributeNode(_);var v=expr_xml.createAttribute("id"),N="mfenced_"+ ++mfenced_cont;v.nodeValue=N,x.setAttributeNode(v);var b=expr_xml.createAttribute("separators");b.nodeValue="",x.setAttributeNode(b);var g=nodeMfrac.appendChild(x),h=expr_xml.createElement("mn"),I=expr_xml.createAttribute("id"),C="mn_"+ ++mn_cont;I.nodeValue=C,h.setAttributeNode(I);var A=expr_xml.createAttribute("color");A.nodeValue="#A4A4A4",h.setAttributeNode(A);var y=expr_xml.createAttribute("mathvariant");y.nodeValue="italic",h.setAttributeNode(y);var V=g.appendChild(h),S=expr_xml.createTextNode(n);V.appendChild(S);currId=""!=i?i:C,CursorPos=1,text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}function ChangeSign(){var e,r,t;if(isScreenMode||ClearAll(),isScreenMode=!0,"root"!=currId&&(e=GetElementById(expr_xml,currId))&&!IsGreyColorNode(e)&&(t=e.parentNode,r=e.tagName,parentNodeId=t.getAttribute("id"),!IsNonErasebleNode(e))){if("mn"!=r){var n="";if((_=e.previousSibling)&&(n=_.tagName),"mo"==n){if("+"==(v=_.childNodes[0].nodeValue))_.childNodes[0].nodeValue="-";else if("-"==v)_.childNodes[0].nodeValue="+";else{if("×"!=v)return;var i=CreateExternalParenthesisNode(e),o=expr_xml.createElement("mo"),a="-",s=expr_xml.createTextNode(a),l=expr_xml.createAttribute("id"),d="mo_"+ ++mo_cont;l.nodeValue=d,o.appendChild(s),o.setAttributeNode(l),e=i.lastChild,i.insertBefore(o,e),currId=i.getAttribute("id"),CursorPos=1}}else{o=expr_xml.createElement("mo"),a="-",s=expr_xml.createTextNode(a),l=expr_xml.createAttribute("id"),d="mo_"+ ++mo_cont;l.nodeValue=d,o.appendChild(s),o.setAttributeNode(l),t.insertBefore(o,e)}}else{var u=e.childNodes[0].nodeValue;if(0==parseFloat(u))return;"."==u&&(u="0");var m=searchCharacter(u,"e"),c=!1;if(0!=m&&(1==CursorPos&&(c=!0),CursorPos<=.5&&NumDigitLeft>=m&&(c=!0)),c){var p=u.substr(m,u.length),f=!1;if(0!=searchCharacter(p,"-")&&(f=!0,p=p.substr(1,p.length)),f){var x=u.substr(0,m)+p;e.childNodes[0].nodeValue=x}else{x=u.substr(0,m)+"-"+p;e.childNodes[0].nodeValue=x}}else{f=!1;var _,v,N=searchCharacter(u,"-");if(0!=N&&(0==m||0!=m&&N<m)&&(f=!0,u=u.substr(1,u.length)),e.childNodes[0].nodeValue=f?u:"-"+u,_=e.previousSibling)if("mo"==(n=_.tagName))if("×"==(v=_.childNodes[0].nodeValue)&&!f){i=CreateExternalParenthesisNode(e);currId=i.getAttribute("id")}CursorPos=1}}text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}}function Eex(){var e,r,t;if(isScreenMode||ClearAll(),isScreenMode=!0,"root"!=currId){if(!(e=GetElementById(expr_xml,currId)))return;if(IsGreyColorNode(e))return;t=e.parentNode,r=e.tagName}else r="",t=expr_xml.documentElement;if("mn"==r){var n=e.childNodes[0].nodeValue;if(0==searchCharacter(n,"e")){"."==n&&(n="0");var i=searchCharacter(n,".");0==searchCharacter(n,".")?n+=".0e":i==n.length?n+="0e":n+="e",e.childNodes[0].nodeValue=n;var o=expr_xml.createElement("mn"),a=expr_xml.createAttribute("id"),s="mn_"+ ++mn_cont;currId=s,a.nodeValue=s,o.setAttributeNode(a);var l,d=expr_xml.createAttribute("color");if(d.nodeValue="#A4A4A4",o.setAttributeNode(d),IsMsupOrMrootSonNode(e)){l=CreateExternalParenthesisNode(e).appendChild(o)}else{var u=e.nextSibling;l=u?t.insertBefore(o,u):t.appendChild(o)}var m=expr_xml.createTextNode("0");l.appendChild(m);CursorPos=1,text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}}}function insertText(e,r,t){return void 0===t&&(t=0),void 0===r&&(r=""),e.slice(0,t)+r+e.slice(t)}function RemoveGreyNodes(e){for(var r=new Array,t=0,n=e.childNodes,i=0;i<n.length;i++)"#A4A4A4"==n[i].getAttribute("color")&&(r[t]=n[i],t++);if(0!=t)for(i=0;i<r.length;i++){var o=r[i];e.removeChild(o)}}function IsCorrectId(e){for(var r=(s=GetElementById(expr_xml,e)).parentNode,t=!0,n=new Array,i=0,o=r.childNodes,a=0;a<o.length;a++)"#A4A4A4"==o[a].getAttribute("color")&&(n[i]=o[a],i++);if(0!=i){for(a=0;a<n.length;a++){var s=n[a];r.removeChild(s)}t=!1}return t}function IsThereAnyCorrectNode(e){if(!e)return!1;for(var r=e.childNodes,t=0,n=0;n<r.length;n++)"#A4A4A4"==r[n].getAttribute("color")&&t++;var i=!0;return t==r.length&&(i=!1),i}function IsGreyColorNode(e){if(!e)return!1;var r=!1;return"#A4A4A4"==e.getAttribute("color")&&(r=!0),r}function FindFirstCorrectNode(e){var r=GetElementById(expr_xml,e),t=!1;(IsExponentOfPower(r)||IsIndexOfRoot(r))&&(t=!0);var n=r.parentNode,i=r;if("#A4A4A4"==r.getAttribute("color")){var o=r.nextSibling;if(o&&!IsMsupOrMrootSonNode(r))if("#A4A4A4"==o.getAttribute("color"))n.removeChild(o),i=null;else{var a=o.tagName;if("mi"==a)","==o.childNodes[0].nodeValue&&(i=o,CursorPos=0);else"mo"==a&&(i=o,CursorPos=0)}else i=null;var s=r.previousSibling;s&&!t&&"#A4A4A4"==s.getAttribute("color")&&n.removeChild(s),n.removeChild(r)}return i}function Solve(){if(!IsVar_DefinitionActive()&&!IsUDF_DefinitionActive())if(isScreenMode){if("root"==currId)return;if(0!=expr_xml.querySelectorAll("[color]").length)return alert("Only numeric expressions are allowed!!!"),"";if(expr_xml_old=expr_xml.cloneNode(!0),0!=UDF_cont&&StringfyUserDefinedFunctions(),0==linsolve_cont&&0==normalize_cont&&0==varLabel_list.length&&0==userDefFunLabel_list.length||(0!=varLabel_list.length&&(expr_xml.documentElement=CorrectGreekLetterVar(expr_xml.documentElement)),ChangeSomeFunctionNames(expr_xml.documentElement)),0!=mtable_cont&&InsertMultiplicationOperator(expr_xml.documentElement),0==eigv_cont){if(""==(e=SolveNode(expr_xml.documentElement)).toString())return void(expr_xml=expr_xml_old.cloneNode(!0));text_screen=InsertResultToXML(e),isZoomFrameRequired=!0}else{var e;if(""==(e=EigenSolveNode(expr_xml.documentElement)))return;text_screen=EigenValues_MathML_format(e)}currId=null,isScreenMode=!1;var r=window.document.getElementById("btnSolve");$(r).html("<strong>EDIT</strong>"),0!=interval_var&&CloseInterval(),Preview.Update()}else{isScreenMode=!0;r=window.document.getElementById("btnSolve");$(r).html("<strong>SOLVE</strong>");var t=expr_xml.documentElement.getAttribute("size");(expr_xml=expr_xml_old.cloneNode(!0)).documentElement.setAttribute("size",t);var n=GetElementById(expr_xml,"root").lastChild;currId=n.getAttribute("id"),CursorPos=1,text_screen=xml_Serial.serializeToString(expr_xml),Preview.SwapBuffers(),Preview.UpdateCursorPosition(),Preview.oldtext=text_screen,0!=interval_var&&CloseInterval(),interval_var=setInterval(myInterval,500)}}function ChangeSomeFunctionNames(e){for(var r=e.querySelectorAll("mi"),t=0;t<r.length;t++){var n=r[t].childNodes[0].nodeValue;if(IsVarMiNode(r[t])){var i=varLabel_list.indexOf(n),o=r[t].parentNode;ReplaceNode_from_VarNode_List(i,r[t],o)}else if(IsUDFMiNode(r[t]))ReplaceUDFMiNode(r[t]);else if("LinSolve"==n)r[t].childNodes[0].nodeValue="lusolve";else if("normalize"==n){r[t].childNodes[0].nodeValue="norm";o=(s=r[t].parentNode).parentNode;var a=r[t].nextSibling.cloneNode(!0);o.insertBefore(a,s);var s,l=CreateExternalParenthesisNode(a),d=CreateOperatorNode("×",l,a=l.lastChild),u=(s=r[t].parentNode).cloneNode(!0);CreateMfracNode(CreateMnElement("1"),u,l,d);o.removeChild(s)}}}function ReplaceUDFMiNode(e){var r=e.childNodes[0].nodeValue;userDefFunLabel_list.indexOf(r);e.childNodes[0].nodeValue="Gen_UDF",parenthesisNode=e.nextSibling,paramNodes=parenthesisNode.childNodes,firstParamNode=parenthesisNode.firstChild;var t=expr_xml.createElement("mn"),n='"'+r+'"',i=expr_xml.createTextNode(n);t.appendChild(i),parenthesisNode.insertBefore(t,firstParamNode);var o=expr_xml.createElement("mi"),a=expr_xml.createTextNode(",");o.appendChild(a),parenthesisNode.insertBefore(o,firstParamNode)}function InsertMultiplicationOperator(e){for(var r=e.querySelectorAll("mtable"),t=0;t<r.length;t++){var n=r[t].parentNode,i=n.parentNode,o=n.previousSibling;if(o&&!IsComaSeparatorNode(o)&&"mo"!=o.tagName){var a=expr_xml.createElement("mo"),s=expr_xml.createTextNode("×");a.appendChild(s),i.insertBefore(a,n)}}}function IsComaSeparatorNode(e){if(!e)return!1;(is_ComaSeparatorNode=!1,"mi"==e.tagName)&&(","==e.childNodes[0].nodeValue&&(is_ComaSeparatorNode=!0));return is_ComaSeparatorNode}function IsMatrixVarMiLabel(e){if(!e)return!1;var r=!1,t=e.childNodes[0].nodeValue;if(IsVarLabel(t)){var n=varLabel_list.indexOf(t);"matrix"==varType_list[n]&&(r=!0)}return r}function IsMatrixResultNode(e){if(!e)return!1;var r=!1;if(IsMatrixVarMiLabel(e))r=!0;else{var t=e.cloneNode(!0);"matrix"==FindOutTypeOfNode(t)&&(r=!0)}return r}function IsVarMiNode(e){if(!e)return!1;var r=!1;return"mi"==e.tagName&&(funType=e.getAttribute("type"),"var"==funType&&(r=!0)),r}function IsVarOrParamMiNode(e){return!!e&&(is_VarOrParamMiNode=!1,(IsVarMiNode(e)||IsParamMiNode(e))&&(is_VarOrParamMiNode=!0),is_VarOrParamMiNode)}function IsVarLabel(e){return-1!=varLabel_list.indexOf(e)}function IsUDFMiNode(e){if(!e)return!1;var r=!1;return"mi"==e.tagName&&(funType=e.getAttribute("type"),"udf"==funType&&(r=!0)),r}function IsThereUDFMiNode(e){if(!e)return!1;var r=!1;return 0!=e.querySelectorAll("mi[type=udf]").length&&(r=!0),r}function IsUDFLabel(e){return-1!=userDefFunLabel_list.indexOf(e)}function IsParamMiNode(e){if(!e)return!1;var r=!1;return"mi"==e.tagName&&(MiType=e.getAttribute("type"),"param"==MiType&&(r=!0)),r}function IsParamMnNode(e){if(!e)return!1;var r=!1;return"mn"==e.tagName&&(MiType=e.getAttribute("type"),"param"==MiType&&(r=!0)),r}function IsParamLabel(e){return-1!=curr_UDF&&-1!=userDefFunParamNames[curr_UDF].indexOf(e)}function lastChar(e){var r=e.length-1;return e.substring(r)}function InputChanges(){Preview.Update(),0!=interval_var&&CloseInterval(),interval_var=setInterval(myInterval,500)}function ClearAll(){isScreenMode=!0;var e,r=expr_xml.documentElement.childNodes;(IsVar_DefinitionActive()||IsUDF_DefinitionActive())&&(e=r[0]);do{var t=r[r.length-1];t&&expr_xml.documentElement.removeChild(t)}while(0!=r.length);(IsVar_DefinitionActive()||IsUDF_DefinitionActive())&&expr_xml.documentElement.appendChild(e),mn_cont=0,mo_cont=0,mi_cont=0,mfrac_cont=0,msqrt_cont=0,msup_cont=0,mfenced_cont=0,mtable_cont=0,mtr_cont=0,mtd_cont=0,mroot_cont=0,linsolve_cont=0,eigv_cont=0,normalize_cont=0,parenthesis_cont=0,UDF_cont=0,currId="root";var n=window.document.getElementById("btnSolve");$(n).html("<strong>SOLVE</strong>"),IsVar_DefinitionActive()||IsUDF_DefinitionActive()?(text_screen=xml_Serial.serializeToString(expr_xml),currId=r[0].getAttribute("id"),InputChanges()):(text_screen=Preview.ClearAll_screen,Preview.buffer.innerHTML=Preview.ClearAll_screen,Preview.oldtext=Preview.ClearAll_text,ScrollLeft_value=0,ScrollTop_value=0,Preview.SwapBuffers(),ZoomOriginal(),0!=interval_var&&CloseInterval(),interval_var=setInterval(myInterval,500))}function searchCharacter(e,r){for(var t=0,n=0;n<e.length;n++)if(e[n]==r){t=n+1;break}return t}function CopyNode(){var e;if(isScreenMode){if("root"==currId)return;if(!(e=GetElementById(expr_xml,currId)))return;if(IsGreyColorNode(e))return}else{if(0!=eigv_cont)return;e=GetElementById(expr_xml,"root").lastChild}StoredNode=e.cloneNode(!0)}function InsertNode(){if(isScreenMode||ClearAll(),isScreenMode=!0,StoredNode){var e,r,t=!1;"root"!=currId?(r=(e=GetElementById(expr_xml,currId)).parentNode,(IsExponentOfPower(e)||IsIndexOfRoot(e))&&(t=!0)):r=expr_xml.documentElement;var n=StoredNode.cloneNode(!0);if(tagName=n.tagName,"mn"==tagName)inputNumber(n.childNodes[0].nodeValue);else if("mo"==tagName){inputOperator(n.childNodes[0].nodeValue)}else{if(e=FindFirstCorrectNode(currId),n=UpdateIdOfNode(n),currId=n.getAttribute("id"),e){if(0==CursorPos)r.insertBefore(n,e),CursorPos=1;else if(1==CursorPos){var i=e.nextSibling;i?r.insertBefore(n,i):r.appendChild(n)}else if(.5==CursorPos&&(e.tagName="mn")){var o=e.childNodes[0].nodeValue,a=o.substring(0,NumDigitLeft);ChangeTextToMnNode(e,o.substring(NumDigitLeft,NumDigitLeft+NumDigitRight));var s=CreateMnElement(a);r.insertBefore(s,e);r.insertBefore(n,e)}}else if(IsMsup(r)||IsMroot(r))if(t)r.appendChild(n);else{var l=r.lastChild;r.insertBefore(n,l)}else r.appendChild(n);text_screen=xml_Serial.serializeToString(expr_xml),InputChanges()}}else alert("There is no node stored!!!")}function UpdateIdOfNode(e){for(var r=e.tagName,t="[id^='mn_']",n=e.querySelectorAll(t),i=0;i<n.length;i++){var o="mn_"+ ++mn_cont;n[i].setAttribute("id",o)}if("mo"==r){o="mo_"+ ++mo_cont;e.setAttribute("id",o)}t="[id^='mo_']",n=e.querySelectorAll(t);for(i=0;i<n.length;i++){o="mo_"+ ++mo_cont;n[i].setAttribute("id",o)}if("mi"==r){o="mi_"+ ++mi_cont;e.setAttribute("id",o)}t="[id^='mi_']",n=e.querySelectorAll(t);for(i=0;i<n.length;i++){o="mi_"+ ++mi_cont;n[i].setAttribute("id",o)}if("mfenced"==r){o="mfenced_"+ ++mfenced_cont;e.setAttribute("id",o)}t="[id^='mfenced_']",n=e.querySelectorAll(t);for(i=0;i<n.length;i++){o="mfenced_"+ ++mfenced_cont;n[i].setAttribute("id",o)}if("msup"==r){o="msup_"+ ++msup_cont;e.setAttribute("id",o)}t="[id^='msup_']",n=e.querySelectorAll(t);for(i=0;i<n.length;i++){o="msup_"+ ++msup_cont;n[i].setAttribute("id",o)}if("msqrt"==r){o="msqrt_"+ ++msqrt_cont;e.setAttribute("id",o)}t="[id^='msqrt_']",n=e.querySelectorAll(t);for(i=0;i<n.length;i++){o="msqrt_"+ ++msqrt_cont;n[i].setAttribute("id",o)}if("mroot"==r){o="mroot_"+ ++mroot_cont;e.setAttribute("id",o)}t="[id^='mroot_']",n=e.querySelectorAll(t);for(i=0;i<n.length;i++){o="mroot_"+ ++mroot_cont;n[i].setAttribute("id",o)}t="[id^='mtable_']",n=e.querySelectorAll(t);for(i=0;i<n.length;i++){o="mtable_"+ ++mtable_cont;n[i].setAttribute("id",o)}return e}function KeyPressFun(e){if(!isInputVarActivated&&!isInputUSFActivated){var r=e.which||e.keyCode;if(42==r)inputOperator("×");else if(43==r){e.key;inputOperator("+")}else if(45==r)inputOperator("-");else if(47==r)Fraction();else if(46==r)inputNumber(".");else if(r>=48&&r<=57){inputNumber((r-48).toString())}}}function KeyDownFun(e){if(!isInputVarActivated&&!isInputUSFActivated){var r=e.which||e.keyCode;if(8==r)Backspace();else if(9==r)e.shiftKey?LeftArrow():RightArrow();else if(13==r)Solve();else if(37==r||38==r)LeftArrow();else if(39==r||40==r)RightArrow();else if(46==r)Supr();else if(r>=65&&r<=90){inputNumber(e.key)}}}Greek_Letter_list=["alpha","beta","gamma","delta","epsilon","zeta","eta","theta","iota","kappa","lambda","mu","nu","xi","omicron","pi","rho","sigma","tau","upsilon","phi","chi","psi","omega","Alpha","Beta","Ggamma","Delta","Epsilon","Zeta","Eta","Theta","Iota","Kappa","Lambda","Mu","Nu","Xi","Omicron","Pi","Rho","Sigma","Tau","Upsilon","Phi","Chi","Psi","Omega"];